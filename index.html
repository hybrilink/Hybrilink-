 <!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Espace Parent - CS la Colombe</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- PWA Meta Tags -->
  <meta name="application-name" content="hybrilink">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Hybrilink">
  <meta name="description" content="Solution complète de gestion de eleve">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#3498db">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="theme-color" content="#3498db">

<!-- Service Worker et mise à jour -->


  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="72x72" href="icon-72x72.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167x167.png">

  

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Styles et Bibliothèques -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


<!-- Scripts de mise à jour -->
<script src="update-system.js"></script>


  

    <style>
        :root {
            --primary: #3498db; --secondary: #2c3e50; --success: #27ae60;
            --danger: #e74c3c; --warning: #f39c12; --info: #1abc9c;
            --light: #ecf0f1; --dark: #34495e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f5f6fa; }
        .hidden { display: none !important; }

        /* --- Styles Communs --- */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-card { background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.08); flex-shrink: 0; transition: transform 0.3s ease; }
        .sidebar.collapsed { transform: translateX(-100%); }
        .nav-menu { list-style: none; padding: 1rem 0; margin: 0; }
        .nav-menu li { position: relative; }
        .nav-menu li a { display: flex; align-items: center; gap: 12px; padding: 14px 20px; color: var(--dark); text-decoration: none; font-weight: 500; }




        .nav-menu li a.active, .nav-menu li a:hover { background: #eaf5fc; color: var(--primary); }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .app-header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .content-area { padding: 1.5rem; flex: 1; }
        .page { display: none; }
        .page.active { display: block; }


/* SOLUTION D'URGENCE */
* {
    max-width: 100vw !important;
    box-sizing: border-box !important;
}

body {
    overflow-x: hidden !important;
    position: relative !important;
}

@media (max-width: 768px) {
    .app-container, .main-content, .content-area {
        width: 100% !important;
        flex-direction: column !important;
    }
    
    table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }
}
/* Styles pour les badges de notification */
.notification-dot {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 12px;
    height: 12px;
    background-color: var(--danger);
    border-radius: 50%;
    animation: pulse 1.5s infinite;
    border: 2px solid white;
}

.notification-dot.small {
    width: 8px;
    height: 8px;
    top: 5px;
    right: 5px;
}

/* Animation pour les nouvelles notifications */
@keyframes highlight {
    0% { background-color: rgba(52, 152, 219, 0.1); }
    100% { background-color: transparent; }
}

.new-notification {
    animation: highlight 2s ease-in-out;
}

/* Styles pour les notifications en plein écran */
.fullscreen-notification {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    padding: 20px;
    color: white;
    text-align: center;
}

/* Ajoutez dans la section CSS de parent.html */
.communique-card.expiring-soon {
    animation: pulse-border-expiring 2s infinite;
    border-left-color: var(--warning);
}

@keyframes pulse-border-expiring {
    0% { border-left-color: var(--warning); }
    50% { border-left-color: #ff9f43; }
    100% { border-left-color: var(--warning); }
}

/* Ajoutez dans le CSS existant */

.file-preview {
    margin: 1rem 0;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid var(--info);
}



/* Styles pour les notifications de mise à jour */
.update-toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: white;
  border-left: 4px solid #3498db;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  padding: 15px 20px;
  min-width: 300px;
  max-width: 400px;
  z-index: 9999;
  transform: translateX(120%);
  transition: transform 0.3s ease;
}

.update-toast.show {
  transform: translateX(0);
}

.update-toast.success {
  border-left-color: #27ae60;
}

.update-toast.warning {
  border-left-color: #f39c12;
}

.update-toast.danger {
  border-left-color: #e74c3c;
}

/* Badges d'application */
.app-badge {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #e74c3c;
  color: white;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  z-index: 99999;
  animation: pulse 1.5s infinite;
}

/* Animation pour badges */
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

/* Badge dans le header */
#notification-count {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #e74c3c;
  color: white;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  animation: pulse 1.5s infinite;
}

/* Styles pour les différentes couleurs de cotes primaires */
.primary-grades-table .grade-excellent {
    background-color: #d4edda !important;
    color: #155724 !important;
    font-weight: bold;
}

.primary-grades-table .grade-good {
    background-color: #fff3cd !important;
    color: #856404 !important;
    font-weight: bold;
}

.primary-grades-table .grade-poor {
    background-color: #f8d7da !important;
    color: #721c24 !important;
    font-weight: bold;
}

/* Badge pour le statut */
.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

.badge-success {
    background-color: var(--success);
    color: white;
}

.badge-warning {
    background-color: var(--warning);
    color: white;
}

/* Badges sur les items du menu */
.nav-menu .notification-dot {
  position: absolute;
  top: 10px;
  right: 15px;
  width: 8px;
  height: 8px;
  background: #e74c3c;
  border-radius: 50%;
  border: 2px solid white;
}

.update-toast.info {
  border-left-color: #3498db;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.update-available {
  animation: pulse 2s infinite;
}


.file-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.file-icon {
    font-size: 2rem;
    color: var(--info);
}

.file-details h5 {
    margin: 0;
    color: var(--dark);
}

/* Styles spécifiques pour les devoirs maternelles */
.primary-homework-item.overdue {
    border-left-color: var(--danger);
    animation: pulse-border 2s infinite;
}

.primary-homework-item.due-soon {
    border-left-color: var(--warning);
}

@keyframes pulse-border {
    0% { border-left-color: var(--danger); }
    50% { border-left-color: #ff6b6b; }
    100% { border-left-color: var(--danger); }
}

.file-details small {
    color: #666;
}

.file-preview-img {
    max-width: 100%;
    max-height: 300px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-top: 1rem;
}

.fullscreen-notification h3 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: white;
}

.fullscreen-notification p {
    font-size: 1.1rem;
    margin-bottom: 2rem;
    max-width: 500px;
}

/* Badge sur l'icône de l'application */
.app-badge {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--danger);
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    z-index: 9999;
}
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); }
        .btn-info { background: var(--info); }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .form-row { display: flex; gap: 1rem; }
        .alert { padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 10px; width: 90%; max-width: 400px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }
        .badge-success { background-color: var(--success); color: white; }
        .badge-warning { background-color: var(--warning); color: white; }
        .badge-danger { background-color: var(--danger); color: white; }
        
        /* --- Styles pour le profil --- */
        .parent-profile { display: flex; align-items: center; gap: 1rem; }
        .parent-photo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .parent-photo-placeholder { width: 40px; height: 40px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; color: #999; }
        .photo-upload { text-align: center; margin: 1rem 0; }
        .photo-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin: 0 auto 1rem; display: block; }
        .photo-placeholder { width: 100px; height: 100px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: #999; }
        .file-input { display: none; }
        .upload-btn { background: var(--info); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        
        /* --- Styles pour le reçu --- */
        .receipt { max-width: 500px; margin: 0 auto; background: white; padding: 1.5rem; border: 1px solid #ddd; font-family: Arial, sans-serif; font-size: 0.9rem; }
        .receipt-header { text-align: center; margin-bottom: 1.5rem; }
        .receipt-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem; }
        .receipt-details { margin-bottom: 1.5rem; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .receipt-divider { border-top: 1px solid #ddd; margin: 1rem 0; }
        .receipt-footer { text-align: center; margin-top: 1.5rem; font-size: 0.8rem; color: #666; }
        
        /* --- Styles pour l'activation de compte --- */
        .activation-steps { display: flex; justify-content: space-between; margin-bottom: 2rem; position: relative; }
        .activation-steps::before { content: ''; position: absolute; top: 20px; left: 0; right: 0; height: 2px; background: #ddd; z-index: 1; }
        .step { text-align: center; position: relative; z-index: 2; flex: 1; }
        .step-number { width: 40px; height: 40px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; font-weight: bold; }
        .step.active .step-number { background: var(--primary); color: white; }
        .step.completed .step-number { background: var(--success); color: white; }
        .step-label { font-size: 0.8rem; color: #666; }
        .step.active .step-label { color: var(--primary); font-weight: 500; }
        
        .child-item { background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid var(--primary); }
        .child-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .child-actions { display: flex; gap: 0.5rem; }
        
        /* --- Styles pour le tableau des notes --- */
        .grade-red { background-color: #ffebee; color: #c62828; font-weight: bold; }
        .grade-green { background-color: #e8f5e8; color: #2e7d32; font-weight: bold; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: 600; }
        tr:hover { background-color: #f8f9fa; }

        /* --- Styles pour les présences et incidents --- */
        .presence-section { margin-bottom: 2rem; }
        .presence-controls { background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .presence-controls-row { display: flex; gap: 1rem; align-items: end; flex-wrap: wrap; }
        .presence-controls .form-group { margin-bottom: 0; flex: 1; min-width: 150px; }
        
        .attendance-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 0.5rem; margin-top: 1rem; }
        .attendance-day { padding: 0.8rem 0.5rem; border-radius: 8px; text-align: center; font-size: 0.8rem; font-weight: 500; border: 2px solid transparent; }
        .attendance-present { background-color: #e8f5e8; color: #2e7d32; border-color: #c8e6c9; }
        .attendance-absent { background-color: #ffebee; color: #c62828; border-color: #ffcdd2; }
        .attendance-late { background-color: #fff3e0; color: #ef6c00; border-color: #ffe0b2; }
        .attendance-empty { background-color: #f8f9fa; color: #6c757d; border: 1px dashed #dee2e6; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; }
        .stat-label { font-size: 0.9rem; color: #666; }
        
        .incident-item { border-left: 4px solid var(--warning); padding: 1.5rem; margin-bottom: 1rem; background: white; border-radius: 0 8px 8px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .incident-item.severity-eleve { border-left-color: var(--danger); }
        .incident-item.severity-moyen { border-left-color: var(--warning); }
        .incident-item.severity-faible { border-left-color: var(--info); }
        
        .incident-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.8rem; flex-wrap: wrap; gap: 0.5rem; }
        .incident-type { font-weight: bold; color: var(--dark); font-size: 1.1rem; }
        .incident-date { color: #666; font-size: 0.9rem; background: #f8f9fa; padding: 0.3rem 0.8rem; border-radius: 15px; }
        .incident-description { margin: 1rem 0; line-height: 1.5; color: #444; }
        .incident-severity { display: inline-block; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-right: 0.5rem; }
        .severity-eleve { background-color: var(--danger); color: white; }
        .severity-moyen { background-color: var(--warning); color: white; }
        .severity-faible { background-color: var(--info); color: white; }
        
        .no-data { text-align: center; padding: 3rem; color: #666; }
        .no-data i { font-size: 3rem; margin-bottom: 1rem; color: #ddd; }
        
        .loading { text-align: center; padding: 2rem; color: #666; }
        .loading i { font-size: 2rem; margin-bottom: 1rem; color: var(--primary); animation: spin 1s linear infinite; }
        
        /* --- Styles pour les horaires de classe --- */
        .class-schedule-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .class-schedule-table th, .class-schedule-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .class-schedule-table th { background-color: var(--primary); color: white; font-weight: 600; }
        .class-schedule-table .hour-header { background-color: var(--info); color: white; }
        .class-schedule-table .day-header { background-color: var(--warning); color: white; }
        .schedule-controls { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .schedule-selector { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .no-schedule { text-align: center; padding: 2rem; color: #666; }
        .schedule-info { background: #e8f4fd; padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
        .timetable-section { margin-bottom: 2rem; }
        .timetable-section:last-child { margin-bottom: 0; }
        

/* Styles pour la gestion des périodes (Parent) */
.period-management {
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.period-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.period-btn {
    padding: 8px 16px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.period-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.period-btn:hover:not(.active) {
    background: #eaf5fc;
    border-color: var(--primary);
}

/* Tableau des cotes primaires (Parent) */
.primary-grades-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.primary-grades-table th {
    background-color: var(--primary);
    color: white;
    padding: 12px;
    text-align: center;
    font-weight: 600;
}

.primary-grades-table td {
    padding: 10px;
    text-align: center;
    border-bottom: 1px solid #eee;
}

.primary-grades-table .course-header {
    background-color: var(--info);
    color: white;
    font-weight: bold;
}

.primary-grades-table .cm-cell {
    background-color: #fff8e1;
    font-weight: 600;
    color: #e67e22;
}

.primary-grades-table .co-cell {
    background-color: #e8f5e9;
    font-weight: 600;
    color: #27ae60;
}

.primary-grades-table .published-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

.primary-grades-table .published {
    background-color: #d4edda;
    color: #155724;
}

.primary-grades-table .not-published {
    background-color: #fff3cd;
    color: #856404;
}
        /* --- Styles pour les devoirs --- */
        .homework-list { margin-top: 1.5rem; }
        .homework-item { 
            border-left: 4px solid var(--info); 
            margin-bottom: 1rem; 
            padding: 1.5rem; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .homework-item.overdue { border-left-color: var(--danger); }
        .homework-item.due-soon { border-left-color: var(--warning); }
        .homework-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .homework-title { font-size: 1.2rem; font-weight: 600; color: var(--dark); margin-bottom: 0.5rem; }
        .homework-meta { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .homework-description { margin-bottom: 1rem; line-height: 1.5; }
        .submission-status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .submission-pending { background-color: #fff3e0; color: #ef6c00; }
        .submission-submitted { background-color: #e8f5e8; color: #2e7d32; }
        .submission-overdue { background-color: #ffebee; color: #c62828; }
        .submission-graded { background-color: #e3f2fd; color: #1565c0; }
        
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 1.5rem; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: 500; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* --- Styles pour les cotes primaires --- */
        .primary-grades-table th, .primary-grades-table td {
            text-align: center;
            padding: 10px;
        }



/* Styles pour le tableau de proclamation parent */
.parent-proclamation-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    font-size: 0.9rem;
}

.parent-proclamation-table th, 
.parent-proclamation-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
}

.parent-proclamation-table th {
    background-color: var(--primary);
    color: white;
    font-weight: 600;
}

.parent-proclamation-table .sub-header {
    background-color: #e9ecef;
    font-weight: 500;
}

.parent-proclamation-table .grade-good {
    background-color: #e8f5e8;
    color: #2e7d32;
    font-weight: bold;
}

.parent-proclamation-table .grade-average {
    background-color: #fff3e0;
    color: #ef6c00;
    font-weight: bold;
}

.parent-proclamation-table .grade-poor {
    background-color: #ffebee;
    color: #c62828;
    font-weight: bold;
}

.parent-proclamation-table .total-row {
    background-color: #e3f2fd !important;
    font-weight: bold;
}

.parent-proclamation-table .ranking-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 50%;
    background-color: var(--primary);
    color: white;
    font-weight: bold;
    min-width: 30px;
    text-align: center;
}

.parent-proclamation-table .ranking-1 {
    background-color: #ffd700;
    color: #000;
}

.parent-proclamation-table .ranking-2 {
    background-color: #c0c0c0;
    color: #000;
}

.parent-proclamation-table .ranking-3 {
    background-color: #cd7f32;
    color: #000;
}

/* Styles pour les cellules de note */
.note-cell {
    font-weight: bold;
    font-size: 1rem;
}

/* Styles pour les résumés */
.grades-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin: 1.5rem 0;
}

.summary-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
    border-left: 4px solid var(--primary);
}

.summary-card h5 {
    margin-bottom: 8px;
    color: var(--dark);
    font-size: 0.9rem;
}

.summary-card .value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary);
}

.summary-card .sub-value {
    font-size: 0.8rem;
    color: #666;
    margin-top: 5px;
}
        
        .primary-grades-table th {
            background-color: var(--primary);
            color: white;
        }
        
        .period-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .period-btn {
            padding: 8px 16px;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .period-btn.active {
            background: var(--primary);
            color: white;
        }

/* Styles pour les fichiers joints */
.file-preview {
    border-left: 4px solid var(--info);
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
}

.file-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.file-details h5 {
    margin: 0;
    color: var(--dark);
}

.file-details p {
    margin: 0.25rem 0;
}

.file-preview-container {
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 1rem;
    background: white;
    margin-top: 1rem;
}

/* Boutons de fichier */
.btn-file {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 8px 16px;
    border-radius: 5px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s;
}

.btn-file:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* Icônes par type de fichier */
.text-danger { color: #e74c3c !important; }
.text-primary { color: #3498db !important; }
.text-success { color: #27ae60 !important; }
.text-warning { color: #f39c12 !important; }
.text-info { color: #1abc9c !important; }
.text-secondary { color: #95a5a6 !important; }
.text-muted { color: #7f8c8d !important; }

/* Badges pour statut */
.badge-overdue {
    background-color: #ff6b6b;
    color: white;
    animation: pulse 1.5s infinite;
}

.badge-due-soon {
    background-color: #ffd166;
    color: #333;
}

.badge-upcoming {
    background-color: #06d6a0;
    color: white;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
        
        .period-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        /* --- Styles pour les sous-onglets --- */
        .sub-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        
        .sub-tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
        }
        
        .sub-tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
            background: white;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }
        
        .sub-tab:hover:not(.active) {
            background: #e9ecef;
        }
        
        .sub-tab-content {
            display: none;
            padding: 1.5rem;
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .sub-tab-content.active {
            display: block;
        }
        
        /* --- Styles pour les devoirs primaires --- */
        .primary-homework-item {
            border-left: 4px solid var(--info);
            margin-bottom: 1rem;
            padding: 1.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .primary-homework-item .homework-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .primary-homework-item .homework-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }
        
        .primary-homework-item .homework-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .primary-homework-item .homework-description {
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        /* --- Styles pour les notifications --- */
        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }

/* --- Styles pour les communiqués --- */
.communique-card {
    background: white;
    border-left: 4px solid var(--primary);
    margin-bottom: 1.5rem;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.communique-card.urgent {
    border-left-color: var(--danger);
    animation: pulse-border 2s infinite;
}

.communique-card.paid {
    border-left-color: var(--success);
    opacity: 0.8;
}

.communique-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.communique-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 0.5rem;
}

.communique-meta {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.communique-meta span {
    margin-right: 1rem;
}

.communique-meta .badge {
    margin-right: 0.5rem;
}

.communique-content {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin: 1rem 0;
    font-family: 'Times New Roman', serif;
    line-height: 1.6;
}

.communique-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #eee;
    flex-wrap: wrap;
    gap: 1rem;
}

.communique-actions {
    display: flex;
    gap: 0.5rem;
}

@keyframes pulse-border {
    0% { border-left-color: var(--danger); }
    50% { border-left-color: #ff6b6b; }
    100% { border-left-color: var(--danger); }
}

/* Modal pour l'affichage complet du communiqué */
.communique-full-modal .modal-content {
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
}

.communique-full-content {
    font-family: 'Times New Roman', serif;
    line-height: 1.8;
}

.communique-full-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--primary);
}

.communique-full-logo {
    max-width: 120px;
    margin-bottom: 1rem;
}

.communique-full-title {
    font-size: 1.5rem;
    font-weight: bold;
    margin: 1rem 0;
    color: var(--dark);
}

.communique-full-date {
    text-align: right;
    font-style: italic;
    color: #666;
    margin-bottom: 2rem;
}

.communique-full-signature {
    margin-top: 3rem;
    text-align: right;
    padding-top: 1rem;
    border-top: 1px solid #ddd;
}

.signature-line {
    border-top: 1px solid #000;
    margin-top: 3rem;
    width: 300px;
    margin-left: auto;
}
        
        /* Notification Toast */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            padding: 15px 20px;
            min-width: 300px;
            max-width: 400px;
            z-index: 9999;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }
        
        .notification-toast.show {
            transform: translateX(0);
        }
        
        .notification-toast.success {
            border-left-color: var(--success);
        }
        
        .notification-toast.warning {
            border-left-color: var(--warning);
        }
        
        .notification-toast.danger {
            border-left-color: var(--danger);
        }
        
        .notification-toast.info {
            border-left-color: var(--info);
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .notification-body {
            font-size: 0.9rem;
            color: #555;
        }
        
        .notification-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Menu mobile --- */
        .menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; color: var(--dark); cursor: pointer; }
        
        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; z-index: 1000; }
            .menu-toggle { display: block; }
            .login-card { padding: 1.5rem; }
            .content-area { padding: 1rem; }
            .card { padding: 1rem; }
            .form-row { flex-direction: column; gap: 0.5rem; }
            .presence-controls-row { flex-direction: column; }
            .presence-controls .form-group { min-width: 100%; }
            .attendance-grid { grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); }
            .stats-grid { grid-template-columns: 1fr; }
            .incident-header { flex-direction: column; align-items: flex-start; }
            .tabs { flex-wrap: wrap; }
            .tab { flex: 1; text-align: center; min-width: 120px; }
            .period-selector { justify-content: center; }
            .period-btn { flex: 1; min-width: 120px; text-align: center; }
            .sub-tabs { flex-direction: column; }
            .sub-tab { border-radius: 8px; margin-bottom: 2px; }
            .sub-tab.active { border-bottom: 2px solid var(--primary); border-radius: 8px 8px 0 0; }
            .notification-toast {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>

<!-- Notification System -->
<script src="firebase-notifications.js"></script>
<script src="notification-manager.js"></script>

<!-- Initialisation automatique -->
<script>
  // Initialiser après connexion
  if (window.currentParent) {
    setTimeout(() => {
      window.notificationManager.initialize();
    }, 3000);
  }
  
  // Tester les notifications (optionnel)
  window.testNotifications = function() {
    if (window.notificationManager) {
      window.notificationManager.test();
    }
    if (window.firebaseNotifications) {
      window.firebaseNotifications.testNotification();
    }
  };
</script>
</head>
<body>
    <!-- Écran de connexion -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-card">
            <h3>Espace Parent</h3>
            <p>Veuillez vous connecter pour continuer.</p>
            
            <!-- Formulaire de connexion -->
            <form id="login-form" style="margin-top: 1.5rem;">
                <div class="form-group">
                    <input type="text" id="login-matricule" class="form-control" placeholder="Matricule parent" required>
                </div>
                <div class="form-group">
                    <input type="password" id="login-password" class="form-control" placeholder="Mot de passe" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Connexion</button>
            </form>
            
            <p style="margin-top: 1rem;">
                <a href="#" id="show-activation-link">Activer mon compte</a>
            </p>
        </div>
        
        <!-- Formulaire d'activation de compte -->
        <div id="activation-card" class="login-card hidden">
            <h3>Activation du Compte Parent</h3>
            <p>Créez votre compte en associant le(s) matricule(s) de votre(vos) enfant(s)</p>
            
            <div class="activation-steps">
                <div class="step active" id="step-1">
                    <div class="step-number">1</div>
                    <div class="step-label">Informations</div>
                </div>
                <div class="step" id="step-2">
                    <div class="step-number">2</div>
                    <div class="step-label">Vérification</div>
                </div>
                <div class="step" id="step-3">
                    <div class="step-number">3</div>
                    <div class="step-label">Compte créé</div>
                </div>
            </div>
            
            <!-- Étape 1: Informations de base -->
            <div id="activation-step-1">
                <form id="activation-form-step1">
                    <div class="form-group">
                        <label>Votre nom complet</label>
                        <input type="text" id="parent-fullname" class="form-control" placeholder="Votre nom complet" required>
                    </div>
                    <div class="form-group">
                        <label>Votre email</label>
                        <input type="email" id="parent-email" class="form-control" placeholder="Votre adresse email" required>
                    </div>
                    <div class="form-group">
                        <label>Votre téléphone</label>
                        <input type="tel" id="parent-phone" class="form-control" placeholder="Votre numéro de téléphone" required>
                    </div>
                    <div class="form-group">
                        <label>Matricule de votre enfant</label>
                        <input type="text" id="child-matricule" class="form-control" placeholder="Matricule de l'élève" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Vérifier le matricule</button>
                </form>
                
                <p style="margin-top: 1rem;">
                    <a href="#" id="show-login-link">Retour à la connexion</a>
                </p>
            </div>
            
            <!-- Étape 2: Vérification et ajout d'enfants -->
            <div id="activation-step-2" class="hidden">
                <div class="alert alert-info">
                    <p><strong>Vérification réussie !</strong></p>
                    <p id="child-info">Élève trouvé: <span id="child-name"></span> - <span id="child-class"></span></p>
                </div>
                
                <div id="children-list">
                    <h4>Enfants associés à votre compte</h4>
                    <div id="children-container">
                        <!-- Les enfants seront ajoutés dynamiquement ici -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ajouter un autre matricule (optionnel)</label>
                    <div class="form-row">
                        <input type="text" id="additional-matricule" class="form-control" placeholder="Matricule d'un autre enfant">
                        <button type="button" id="add-child-btn" class="btn btn-info">Ajouter</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Créer votre mot de passe</label>
                    <input type="password" id="parent-password" class="form-control" placeholder="Votre mot de passe" required>
                </div>
                
                <div class="form-group">
                    <label>Confirmer le mot de passe</label>
                    <input type="password" id="parent-password-confirm" class="form-control" placeholder="Confirmer le mot de passe" required>
                </div>
                
                <button type="button" id="create-account-btn" class="btn btn-success" style="width: 100%;">Créer mon compte</button>
                
                <p style="margin-top: 1rem;">
                    <a href="#" id="back-to-step1">Retour à l'étape précédente</a>
                </p>
            </div>
            
            <!-- Étape 3: Compte créé -->
            <div id="activation-step-3" class="hidden">
                <div class="alert alert-success">
                    <h4>Compte créé avec succès !</h4>
                    <p>Votre compte parent a été créé avec les informations suivientes :</p>
                </div>
                
                <div style="text-align: left; margin: 1rem 0;">
                    <p><strong>Matricule parent:</strong> <span id="created-parent-matricule"></span></p>
                    <p><strong>Nom:</strong> <span id="created-parent-name"></span></p>
                    <p><strong>Email:</strong> <span id="created-parent-email"></span></p>
                    <p><strong>Enfants associés:</strong> <span id="created-children-count"></span></p>
                </div>
                
                <p>Vous pouvez maintenant vous connecter avec votre matricule parent et votre mot de passe.</p>
                
                <button type="button" id="go-to-login-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Se connecter</button>
            </div>
        </div>
    </div>

    <!-- Contenu de l'application -->
    <div id="app-root" class="app-container hidden">
        <nav class="sidebar">
            <div style="padding: 1.5rem; text-align: center; border-bottom: 1px solid #eee;">
                <i class="fas fa-user-friends" style="font-size: 2rem; color: var(--primary);"></i>
                <h3 style="margin-top: 0.5rem;">Espace Parent</h3>
            </div>
            <ul class="nav-menu">
                <li><a href="#" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt fa-fw"></i> Tableau de bord</a></li>
                <li><a href="#" data-page="grades"><i class="fas fa-chart-line fa-fw"></i> Cotes et Notes</a></li>
                <li><a href="#" data-page="presence-incidents"><i class="fas fa-clipboard-check fa-fw"></i> Présence & Incidents</a></li>

<li><a href="#" data-page="communiques"><i class="fas fa-newspaper fa-fw"></i> Communiqués</a></li>
                <li><a href="#" data-page="payments"><i class="fas fa-money-bill-wave fa-fw"></i> Paiements</a></li>
                <li><a href="#" data-page="homework"><i class="fas fa-book-open fa-fw"></i> Devoirs</a></li>
                <li><a href="#" data-page="timetable"><i class="fas fa-clock fa-fw"></i> Temps Horaire</a></li>
                <li><a href="#" data-page="children"><i class="fas fa-child fa-fw"></i> Mes Enfants</a></li>
                <li><a href="#" data-page="profile"><i class="fas fa-user fa-fw"></i> Mon Profil</a></li>
                <li><a href="#" data-page="communication"><i class="fas fa-envelope fa-fw"></i> Messagerie</a></li>
                <li><a href="#" data-page="notifications"><i class="fas fa-bell fa-fw"></i> Notifications</a></li>
            </ul>
        </nav>
        <div class="main-content">
            <header class="app-header">
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 id="page-title">Tableau de bord</h2>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="parent-profile">
                        <div id="parent-photo-container">
                            <!-- La photo sera insérée ici dynamiquement -->
                        </div>
                        <span id="parent-name"></span>
                    </div>
                    <div style="position: relative;">
                        <button id="notification-bell" class="btn btn-info">
                            <i class="fas fa-bell"></i>
                            <span id="notification-count" class="hidden" style="position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center;">0</span>
                        </button>
                    </div>
                    <button id="logout-btn" class="btn btn-danger">Déconnexion</button>
                </div>
            </header>
            <main class="content-area">
                <div id="global-alert" class="alert hidden"></div>

                <!-- Page: Tableau de bord -->
                <div id="dashboard-page" class="page active">
                    <div class="card">
                        <h3>Bienvenue dans votre espace parent</h3>
                        <p>Vous pouvez suivre la scolarité de vos enfants, gérer les paiements et communiquer avec l'établissement.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="child-selector"><strong>Sélectionner un enfant pour voir ses informations :</strong></label>
                        <select id="child-selector" class="form-control"></select>
                    </div>
                    <div id="child-dashboard-content" class="hidden">
                        <div class="card">
                            <h3><i class="fas fa-chart-line"></i> Notes de l'Enfant</h3>
                            <div id="grades-container">
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>N°</th>
                                                <th>Matière</th>
                                                <th>Type d'évaluation</th>
                                                <th>Points maximum</th>
                                                <th>Points obtenus</th>
                                                <th>Pourcentage</th>
                                                <th>Enseignant</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="child-grades-table-body">
                                            <!-- Les notes de l'enfant seront chargées ici -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-calendar-check"></i> Dernières Présences</h3>
                            <div id="attendance-container"></div>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-book-open"></i> Devoirs Récents</h3>
                            <div id="homework-container"></div>
                        </div>
                    </div>
                </div>

<!-- Page: Communiqués -->
<div id="communiques-page" class="page">
    <div class="card">
        <div class="form-row" style="justify-content: space-between; align-items: center;">
            <h3><i class="fas fa-newspaper"></i> Mes Communiqués</h3>
            <button id="refresh-communiques-btn" class="btn btn-primary btn-sm">
                <i class="fas fa-sync-alt"></i> Actualiser
            </button>
        </div>
        
        <div class="form-group">
            <label for="communique-child-selector"><strong>Filtrer par enfant :</strong></label>
            <select id="communique-child-selector" class="form-control">
                <option value="all">Tous mes enfants</option>
                <!-- Les enfants seront chargés dynamiquement -->
            </select>
        </div>
        
        <div class="form-group">
            <label for="communique-type-filter"><strong>Filtrer par type de frais :</strong></label>
            <select id="communique-type-filter" class="form-control">
                <option value="all">Tous les frais</option>
                <option value="Frais scolaires">Frais scolaires</option>
                <option value="Frais de l'état">Frais de l'état</option>
                <option value="visite">Visite</option>
                <option value="achat pull">Achat pull</option>
                <option value="Frais d'inscription">Frais d'inscription</option>
                <option value="Autres">Autres</option>
            </select>
        </div>
        
        <div id="communiques-list-container">
            <!-- Liste des communiqués personnalisés pour chaque enfant -->
        </div>
    </div>
</div>

                <!-- Page: Cotes et Notes (Regroupement) -->
                <div id="grades-page" class="page">
                    <div class="card">
                        <h3><i class="fas fa-chart-line"></i> Cotes et Notes des Enfants</h3>
                        <p>Consultez les notes et cotes publiées par les enseignants pour vos enfants.</p>
                    </div>
                    
                    <!-- Sous-onglets pour les différents niveaux -->
                    <div class="sub-tabs">
                        <div class="sub-tab active" data-sub-tab="secondary-grades">
                            <i class="fas fa-graduation-cap"></i> Notes Secondaire
                        </div>
                        <div class="sub-tab" data-sub-tab="primary-grades">
                            <i class="fas fa-chart-bar"></i> Cotes Primaire
                        </div>
                        <div class="sub-tab" data-sub-tab="kindergarten-grades">
                            <i class="fas fa-baby"></i> Cotes Maternelle
                        </div>
                    </div>
                    
                    <!-- Sous-onglet: Notes Secondaire -->
<div id="secondary-grades-tab" class="sub-tab-content active">
    <div class="card">
        <h4>Système de Réception des Cotes par Période</h4>
        <p>Consultez les cotes publiées par les enseignants pour votre enfant, organisées par période scolaire.</p>
    </div>
    
    <div class="form-group">
        <label for="secondary-grades-child-selector"><strong>Sélectionner un enfant du secondaire :</strong></label>
        <select id="secondary-grades-child-selector" class="form-control"></select>
    </div>
    
    <div id="secondary-grades-content" class="hidden">
        <!-- Sélecteur de période -->
        <div class="period-selector" style="margin: 1.5rem 0;">
            <button class="period-btn active" data-period="P1">1ère Période</button>
            <button class="period-btn" data-period="P2">2ème Période</button>
            <button class="period-btn" data-period="EXAM_S1">Examen Semestre 1</button>
            <button class="period-btn" data-period="TOTAL_S1">Total Semestre 1</button>
            <button class="period-btn" data-period="P3">3ème Période</button>
            <button class="period-btn" data-period="P4">4ème Période</button>
            <button class="period-btn" data-period="EXAM_S2">Examen Semestre 2</button>
            <button class="period-btn" data-period="TOTAL_S2">Total Semestre 2</button>
            <button class="period-btn" data-period="TOTAL_GENERAL">Total Général</button>
        </div>
        
        <!-- Information sur la période -->
       <div id="period-info-card" class="card hidden" style="background: #e8f4fd; margin-bottom: 1.5rem;">
    <h4>Période Sélectionnée: <span id="selected-period-name"></span></h4>
    <p id="period-calculation-info"></p>
    <p id="period-auto-calc-info" class="hidden" style="color: #2e7d32; font-style: italic;">
        <i class="fas fa-calculator"></i> Calcul automatique activé
    </p>
</div>
        
        <div class="loading" id="secondary-grades-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Chargement des cotes...</p>
        </div>
        
        <!-- Tableau de proclamation (similaire au titulaire) -->
        <div id="grades-table-container" class="hidden">
            <div class="card">
                <h4>Tableau des Cotes - <span id="child-name-header"></span></h4>
                <div class="download-options">
                    <button id="download-grades-excel-btn" class="btn btn-success btn-sm">
                        <i class="fas fa-file-excel"></i> Exporter Excel
                    </button>
                    <button id="download-grades-pdf-btn" class="btn btn-danger btn-sm">
                        <i class="fas fa-file-pdf"></i> Exporter PDF
                    </button>
                </div>
                <div id="grades-proclamation-table-container" class="table-container" style="margin-top: 1rem;"></div>
            </div>
        </div>
        
        <div id="no-grades-message" class="hidden">
            <div class="no-data">
                <i class="fas fa-chart-line"></i>
                <h3>Aucune cote disponible</h3>
                <p>Aucune cote n'a été publiée pour cet enfant pour la période sélectionnée.</p>
            </div>
        </div>
    </div>
</div>
                    
                    <!-- Sous-onglet: Cotes Primaire -->
<div id="primary-grades-tab" class="sub-tab-content">
    <div class="form-group">
        <label for="primary-grades-child-selector"><strong>Sélectionner un enfant du primaire :</strong></label>
        <select id="primary-grades-child-selector" class="form-control"></select>
    </div>
    
    <div id="primary-grades-content" class="hidden">
        <!-- Gestion des périodes -->
        <div class="card period-management" style="margin-bottom: 1.5rem;">
            <h4>Sélectionner la période</h4>
            <div class="period-buttons" style="margin-top: 1rem;">
                <button class="period-btn active" data-period="1ère P">1ère P</button>
                <button class="period-btn" data-period="2ème P">2ème P</button>
                <button class="period-btn" data-period="Examen S1">Examen S1</button>
                <button class="period-btn" data-period="3ème P">3ème P</button>
                <button class="period-btn" data-period="4ème P">4ème P</button>
                <button class="period-btn" data-period="Examen S2">Examen S2</button>
            </div>
        </div>
        
        <div class="loading" id="primary-grades-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Chargement des cotes...</p>
        </div>
        
        <div id="primary-grades-container">
            <!-- Le tableau sera généré dynamiquement ici -->
        </div>
        
        <div id="primary-grades-summary" class="card hidden" style="margin-top: 1.5rem;">
            <h4>Résumé des Cotes</h4>
            <div id="primary-grades-stats">
                <!-- Les statistiques des cotes seront affichées ici -->
            </div>
        </div>
    </div>
</div>
                    
                    <!-- Sous-onglet: Cotes Maternelle -->
                    <div id="kindergarten-grades-tab" class="sub-tab-content">
                        <div class="form-group">
                            <label for="kindergarten-grades-child-selector"><strong>Sélectionner un enfant de la maternelle :</strong></label>
                            <select id="kindergarten-grades-child-selector" class="form-control"></select>
                        </div>
                        
                        <div id="kindergarten-grades-content" class="hidden">
                            <div class="loading" id="kindergarten-grades-loading">
                                <i class="fas fa-spinner"></i>
                                <p>Chargement des cotes...</p>
                            </div>
                            
                            <div id="kindergarten-grades-container">
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>N°</th>
                                                <th>Compétence</th>
                                                <th>Niveau</th>
                                                <th>Appréciation</th>
                                                <th>Date d'évaluation</th>
                                                <th>Enseignant</th>
                                            </tr>
                                        </thead>
                                        <tbody id="kindergarten-grades-table-body">
                                            <!-- Les cotes maternelles seront chargées ici -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Présence & Incidents -->
                <div id="presence-incidents-page" class="page">
                    <div class="card">
                        <h3><i class="fas fa-clipboard-check"></i> Suivi des Présences et Incidents</h3>
                        <p>Consultez les présences publiées et les incidents signalés pour vos enfants.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="presence-child-selector"><strong>Sélectionner un enfant :</strong></label>
                        <select id="presence-child-selector" class="form-control"></select>
                    </div>
                    
                    <div id="presence-incidents-content" class="hidden">
                        <!-- Section Présences -->
                        <div class="card presence-section">
                            <h3><i class="fas fa-calendar-alt"></i> Présences Mensuelles</h3>
                            
                            <div class="presence-controls">
                                <div class="presence-controls-row">
                                    <div class="form-group">
                                        <label>Mois</label>
                                        <select id="presence-month" class="form-control">
                                            <option value="0">Janvier</option>
                                            <option value="1">Février</option>
                                            <option value="2">Mars</option>
                                            <option value="3">Avril</option>
                                            <option value="4">Mai</option>
                                            <option value="5">Juin</option>
                                            <option value="6">Juillet</option>
                                            <option value="7">Août</option>
                                            <option value="8">Septembre</option>
                                            <option value="9">Octobre</option>
                                            <option value="10">Novembre</option>
                                            <option value="11">Décembre</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Année</label>
                                        <select id="presence-year" class="form-control">
                                            <!-- Les années seront chargées dynamiquement -->
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>&nbsp;</label>
                                        <button id="load-presence-btn" class="btn btn-primary" style="width: 100%;">
                                            <i class="fas fa-sync-alt"></i> Charger les présences
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="presence-stats">
                                <!-- Les statistiques seront affichées ici -->
                            </div>
                            
                            <div id="monthly-presence-container">
                                <div class="no-data">
                                    <i class="fas fa-calendar"></i>
                                    <p>Sélectionnez un mois et une année pour voir les présences de votre enfant.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section Incidents -->
                        <div class="card presence-section">
                            <h3><i class="fas fa-exclamation-triangle"></i> Incidents Signalés</h3>
                            <div id="incidents-list-container">
                                <div class="loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>Chargement des incidents...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Paiements -->
                <div id="payments-page" class="page">
                    <h2>Gestion des Paiements</h2>
                    <div class="form-group">
                        <label for="payment-child-selector"><strong>Sélectionner un enfant :</strong></label>
                        <select id="payment-child-selector" class="form-control"></select>
                    </div>
                    <div id="payment-content" class="hidden">
                        <div class="card">
                            <h3>Statut des Paiements</h3>
                            <div id="payment-status-container"></div>
                        </div>
                        <div class="card">
                            <h3>Paiement en ligne</h3>
                            <form id="online-payment-form">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Matricule de l'élève</label>
                                        <input type="text" id="payment-student-id" class="form-control" readonly>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label>Nom complet de l'élève</label>
                                        <input type="text" id="payment-student-name" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Classe</label>
                                        <input type="text" id="payment-student-class" class="form-control" readonly>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Mois de paiement</label>
                                        <select id="payment-month" class="form-control" required>
                                            <option value="janvier">Janvier</option>
                                            <option value="février">Février</option>
                                            <option value="mars">Mars</option>
                                            <option value="avril">Avril</option>
                                            <option value="mai">Mai</option>
                                            <option value="juin">Juin</option>
                                            <option value="juillet">Juillet</option>
                                            <option value="août">Août</option>
                                            <option value="septembre">Septembre</option>
                                            <option value="octobre">Octobre</option>
                                            <option value="novembre">Novembre</option>
                                            <option value="décembre">Décembre</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Montant (FCFA)</label>
                                        <input type="number" id="payment-amount" class="form-control" placeholder="30000" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Valider le paiement</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Page: Devoirs (Regroupement) -->
                <div id="homework-page" class="page">
                    <div class="card">
                        <h3>Devoirs des Enfants</h3>
                        <p>Consultez les devoirs assignés à vos enfants selon leur niveau scolaire.</p>
                    </div>
                    
                    <!-- Sous-onglets pour les différents niveaux -->
                    <div class="sub-tabs">
                        <div class="sub-tab active" data-sub-tab="secondary-homework">
                            <i class="fas fa-graduation-cap"></i> Devoirs Secondaire
                        </div>
                        <div class="sub-tab" data-sub-tab="primary-homework">
                            <i class="fas fa-book"></i> Devoirs Primaire
                        </div>
                        <div class="sub-tab" data-sub-tab="kindergarten-homework">
                            <i class="fas fa-baby"></i> Devoirs Maternelle
                        </div>
                    </div>
                    
                    <!-- Sous-onglet: Devoirs Secondaire -->
                    <div id="secondary-homework-tab" class="sub-tab-content active">
                        <div class="form-group">
                            <label for="secondary-homework-child-selector"><strong>Sélectionner un enfant du secondaire :</strong></label>
                            <select id="secondary-homework-child-selector" class="form-control"></select>
                        </div>
                        
                        <div id="secondary-homework-content" class="hidden">
                            <div class="tabs">
                                <div class="tab active" data-tab="pending">Devoirs en cours</div>
                                <div class="tab" data-tab="submitted">Devoirs rendus</div>
                            </div>
                            
                            <div id="pending-tab" class="tab-content active">
                                <div class="loading" id="pending-homework-loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>Chargement des devoirs en cours...</p>
                                </div>
                                <div id="pending-homework-container">
                                    <!-- Les devoirs en cours seront chargés dynamiquement ici -->
                                </div>
                            </div>
                            
                            <div id="submitted-tab" class="tab-content">
                                <div class="loading" id="submitted-homework-loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>Chargement des devoirs rendus...</p>
                                </div>
                                <div id="submitted-homework-container">
                                    <!-- Les devoirs rendus seront chargés dynamiquement ici -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sous-onglet: Devoirs Primaire -->
                    <div id="primary-homework-tab" class="sub-tab-content">
                        <div class="form-group">
                            <label for="primary-homework-child-selector"><strong>Sélectionner un enfant du primaire :</strong></label>
                            <select id="primary-homework-child-selector" class="form-control"></select>
                        </div>
                        
                        <div id="primary-homework-content" class="hidden">
                            <div class="loading" id="primary-homework-loading">
                                <i class="fas fa-spinner"></i>
                                <p>Chargement des devoirs...</p>
                            </div>
                            <div id="primary-homework-container">
                                <!-- Les devoirs du primaire seront chargés dynamiquement ici -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sous-onglet: Devoirs Maternelle -->
                    <div id="kindergarten-homework-tab" class="sub-tab-content">
                        <div class="form-group">
                            <label for="kindergarten-homework-child-selector"><strong>Sélectionner un enfant de la maternelle :</strong></label>
                            <select id="kindergarten-homework-child-selector" class="form-control"></select>
                        </div>
                        
                        <div id="kindergarten-homework-content" class="hidden">
                            <div class="loading" id="kindergarten-homework-loading">
                                <i class="fas fa-spinner"></i>
                                <p>Chargement des devoirs...</p>
                            </div>
                            <div id="kindergarten-homework-container">
                                <!-- Les devoirs de la maternelle seront chargés dynamiquement ici -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Page: Temps Horaire -->
                <div id="timetable-page" class="page">
                    <div class="card">
                        <h3>Temps Horaire des Enfants</h3>
                        <p>Consultez les horaires de classe de vos enfants.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="timetable-child-selector"><strong>Sélectionner un enfant :</strong></label>
                        <select id="timetable-child-selector" class="form-control"></select>
                    </div>
                    
                    <div id="timetable-content" class="hidden">
                        <div class="schedule-controls">
                            <div class="form-group" style="flex: 1;">
                                <label>Sélectionner le mois</label>
                                <input type="month" id="timetable-month" class="form-control">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Sélectionner la semaine</label>
                                <select id="timetable-week" class="form-control">
                                    <option value="">-- Toutes les semaines --</option>
                                    <option value="1">Semaine 1</option>
                                    <option value="2">Semaine 2</option>
                                    <option value="3">Semaine 3</option>
                                    <option value="4">Semaine 4</option>
                                    <option value="5">Semaine 5</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1; display: flex; align-items: flex-end;">
                                <button id="load-timetable-btn" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Rechercher
                                </button>
                            </div>
                        </div>
                        
                        <div id="timetable-container">
                            <div class="loading" id="timetable-loading">
                                <i class="fas fa-spinner"></i>
                                <p>Chargement de l'horaire...</p>
                            </div>
                            <div id="timetable-display">
                                <!-- Le contenu de l'horaire sera chargé dynamiquement ici -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Page: Mes Enfants -->
                <div id="children-page" class="page">
                    <div class="card">
                        <div class="form-row" style="justify-content: space-between; align-items: center;">
                            <h3>Mes Enfants</h3>
                            <button id="add-child-account-btn" class="btn btn-primary">Ajouter un enfant</button>
                        </div>
                        
                        <div id="children-list-container">
                            <!-- Liste des enfants associés au compte -->
                        </div>
                    </div>
                </div>
                
                <!-- Page: Mon Profil -->
                <div id="profile-page" class="page">
                    <div class="card">
                        <h3>Mon Profil</h3>
                        
                        <!-- Photo de profil -->
                        <div class="photo-upload">
                            <div id="profile-photo-preview" class="photo-placeholder">
                                <i class="fas fa-user"></i>
                            </div>
                            <input type="file" id="profile-photo" class="file-input" accept="image/*">
                            <button type="button" class="upload-btn" onclick="document.getElementById('profile-photo').click()">
                                <i class="fas fa-upload"></i> Changer la photo
                            </button>
                        </div>
                        
                        <form id="profile-form">
                            <div class="form-group">
                                <label>Matricule Parent</label>
                                <input type="text" id="profile-matricule" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label>Nom Complet</label>
                                <input type="text" id="profile-fullname" class="form-control" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="profile-email" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Téléphone</label>
                                    <input type="tel" id="profile-phone" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nouveau mot de passe (laisser vide pour ne pas changer)</label>
                                <input type="password" id="profile-new-password" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Confirmer le nouveau mot de passe</label>
                                <input type="password" id="profile-confirm-password" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Notifications Push</label>
                                <div style="margin-top: 10px;">
                                    <button type="button" id="enable-notifications-btn" class="btn btn-info btn-sm">
                                        <i class="fas fa-bell"></i> Activer les notifications
                                    </button>
                                    <button type="button" id="test-notification-btn" class="btn btn-warning btn-sm">
                                        <i class="fas fa-paper-plane"></i> Tester une notification
                                    </button>
                                </div>
                                <div id="notification-status" style="margin-top: 10px; font-size: 0.9rem;"></div>
                            </div>
                            <button type="submit" class="btn btn-primary">Mettre à jour le profil</button>
                        </form>
                    </div>
                </div>
                
                <!-- Page: Messagerie -->
                <div id="communication-page" class="page">
                    <div class="card">
                        <h3>Messagerie</h3>
                        <p>Module de messagerie en développement.</p>
                    </div>
                </div>
                
                <!-- Page: Notifications -->
                <div id="notifications-page" class="page">
                    <div class="card">
                        <div class="form-row" style="justify-content: space-between; align-items: center;">
                            <h3>Mes Notifications</h3>
                            <button id="clear-all-notifications-btn" class="btn btn-danger btn-sm">Tout effacer</button>
                        </div>
                        
                        <div class="form-group">
                            <label>Filtrer par type</label>
                            <select id="notification-filter" class="form-control">
                                <option value="all">Toutes les notifications</option>
                                <option value="grades">Nouvelles notes</option>
                                <option value="homework">Devoirs</option>
                                <option value="incidents">Incidents</option>
                                <option value="payments">Paiements</option>
                                <option value="messages">Messages</option>
                                <option value="announcements">Annonces</option>
                            </select>
                        </div>
                        
                        <div id="notifications-list-container">
                            <!-- Liste des notifications -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modale pour le code de paiement -->
    <div id="payment-code-modal" class="modal hidden">
        <div class="modal-content" style="text-align: center; max-width: 450px;">
            <div class="modal-header">
                <h3>Code de Paiement Généré</h3>
                <button class="close-modal">&times;</button>
            </div>
            <p>Présentez ce code au secrétariat pour finaliser le paiement.</p>
            <div id="generated-code" style="font-size: 1.5rem; font-weight: bold; color: var(--primary); background: #f0f0f0; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 2px dashed var(--primary);"></div>
            
            <div id="receipt-preview" style="text-align: left; margin: 1rem 0;">
                <!-- Prévisualisation du reçu -->
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-primary" onclick="closeModal('payment-code-modal')">Fermer</button>
                <button id="download-receipt-btn" class="btn btn-success">Télécharger le reçu</button>
            </div>
        </div>
    </div>

    <!-- Modale pour ajouter un enfant -->
    <div id="add-child-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ajouter un enfant</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="add-child-form">
                <div class="form-group">
                    <label>Matricule de l'enfant</label>
                    <input type="text" id="new-child-matricule" class="form-control" placeholder="Matricule de l'élève" required>
                </div>
                <div class="alert alert-info hidden" id="child-verification-result">
                    <!-- Résultat de la vérification -->
                </div>
                <div class="form-group">
                    <label>Relation avec l'enfant</label>
                    <select id="child-relation" class="form-control" required>
                        <option value="parent">Parent</option>
                        <option value="tuteur">Tuteur</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Ajouter l'enfant</button>
            </form>
        </div>
    </div>

<!-- Modal pour l'affichage complet du communiqué -->
<div id="communique-full-modal" class="modal hidden communique-full-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Communiqué de Paiement</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div id="communique-full-content" class="communique-full-content">
          html
<!-- Modifiez le bouton d'impression dans le modal -->
<div style="text-align: center; margin-top: 1.5rem;">
    <button id="print-communique-btn" class="btn btn-primary">
        <i class="fas fa-print"></i> Imprimer
    </button>
    <button class="btn btn-secondary" onclick="closeModal('communique-full-modal')">
        Fermer
    </button>
</div>

    </div>
</div>
<script type="module">
// ============================================
// CONFIGURATION FIREBASE
// ============================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, collection, getDocs, query, where, addDoc, serverTimestamp, doc, updateDoc, orderBy, getDoc, setDoc, onSnapshot, limit, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging.js";

// Configuration Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBn7VIddclO7KtrXb5sibCr9SjVLjOy-qI",
  authDomain: "theo1d.firebaseapp.com",
  projectId: "theo1d",
  storageBucket: "theo1d.firebasestorage.app",
  messagingSenderId: "269629842962",
  appId: "1:269629842962:web:a80a12b04448fe1e595acb",
  measurementId: "G-TNSG1XFMDZ"
};

// Initialiser Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let messaging = null;

// Clé VAPID pour FCM
const VAPID_KEY = "BM8H6cADaP6tiA4t9Oc9D36jk1UmYoUBV3cATlJ5mvZ_-eQ5xd6HgX5twxWvZ2U2Y98HBkJ8bTph7epPJJYqBpc";

// Configuration Cloudinary
const CLOUDINARY_CONFIG = {
    cloudName: 'diwn8sxtn',
    uploadPreset: 'cs_lacolombe'
};

// ============================================
// VARIABLES GLOBALES
// ============================================
let currentParent = null;
let childrenList = [];
let parentPhotoFile = null;
let currentPrimaryPeriod = '1ère période';
let notifications = [];
let verifiedChildren = [];

// Stocker les compteurs de notifications
let notificationCounts = {
    dashboard: 0,
    grades: 0,
    'presence-incidents': 0,
    payments: 0,
    homework: 0,
    timetable: 0,
    children: 0,
    profile: 0,
    communication: 0,
    notifications: 0
};

// ============================================
// INITIALISATION DU SERVICE WORKER
// ============================================
async function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    try {
      const registration = await navigator.serviceWorker.register('firebase-messaging-sw.js');
      console.log('✅ Service Worker enregistré avec succès:', registration.scope);
      return registration;
    } catch (error) {
      console.error('❌ Erreur enregistrement Service Worker:', error);
    }
  }
  return null;
}

// ============================================
// INITIALISATION FIREBASE MESSAGING
// ============================================
async function initializeFirebaseMessaging() {
  try {
    if (!('Notification' in window)) {
      console.log('❌ Ce navigateur ne supporte pas les notifications');
      return null;
    }

    const isMessagingSupported = await isSupported();
    if (!isMessagingSupported) {
      console.log('❌ Firebase Messaging non supporté');
      return null;
    }

    messaging = getMessaging(app);

    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      console.log('❌ Permission de notification refusée');
      return null;
    }

    const registration = await registerServiceWorker();

    const token = await getToken(messaging, {
      vapidKey: VAPID_KEY,
      serviceWorkerRegistration: registration
    });

    if (token) {
      console.log('✅ Token FCM obtenu:', token.substring(0, 30) + '...');
      
      if (currentParent) {
        await saveFCMToken(token);
      }
    }

    return messaging;

  } catch (error) {
    console.error('❌ Erreur initialisation Firebase Messaging:', error);
    return null;
  }
}

// ============================================
// SAUVEGARDER LE TOKEN FCM
// ============================================
async function saveFCMToken(token) {
  if (!currentParent || !currentParent.matricule) return;
  
  try {
    const parentRef = doc(db, 'parents', currentParent.matricule);
    await updateDoc(parentRef, {
      fcmToken: token,
      fcmTokenUpdatedAt: serverTimestamp(),
      notificationEnabled: true
    });
    console.log('✅ Token FCM sauvegardé dans Firestore');
  } catch (error) {
    console.error('❌ Erreur sauvegarde token:', error);
  }
}

// ============================================
// CONFIGURER LES ÉCOUTEURS EN TEMPS RÉEL
// ============================================
function setupRealtimeListeners() {
  if (!currentParent || childrenList.length === 0) return;

  console.log('🔔 Configuration des écouteurs en temps réel...');

  childrenList.forEach(child => {
    
    // 1. Écouter les nouvelles notes (secondaire)
    if (child.type === 'secondary') {
      const gradesQuery = query(
        collection(db, 'parent_grades'),
        where('className', '==', child.class)
      );
      
      onSnapshot(gradesQuery, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === 'added') {
            const gradeData = change.doc.data();
            const hasStudentGrade = gradeData.grades?.some(g => 
              g.studentMatricule === child.matricule
            );
            
            if (hasStudentGrade) {
              const notification = {
                title: '📊 Nouvelle note publiée',
                body: `${child.fullName} a reçu une note en ${gradeData.subject}`,
                type: 'grades',
                page: 'grades',
                childId: child.matricule,
                childName: child.fullName,
                timestamp: new Date().toISOString()
              };
              
              sendNotification(notification);
            }
          }
        });
      });
    }

    // 2. Écouter les incidents
    const incidentsQuery = query(
      collection(db, 'incidents'),
      where('studentMatricule', '==', child.matricule)
    );
    
    onSnapshot(incidentsQuery, (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'added') {
          const incident = change.doc.data();
          
          const notification = {
            title: '⚠️ Nouvel incident signalé',
            body: `${child.fullName}: ${incident.type || 'Incident'}`,
            type: 'incidents',
            page: 'presence-incidents',
            childId: child.matricule,
            childName: child.fullName,
            timestamp: new Date().toISOString()
          };
          
          sendNotification(notification);
        }
      });
    });

    // 3. Écouter les devoirs (secondaire)
    if (child.type === 'secondary') {
      const homeworkQuery = query(
        collection(db, 'homework'),
        where('className', '==', child.class)
      );
      
      onSnapshot(homeworkQuery, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === 'added') {
            const homework = change.doc.data();
            
            const notification = {
              title: '📚 Nouveau devoir',
              body: `${child.fullName}: ${homework.subject} - ${homework.title}`,
              type: 'homework',
              page: 'homework',
              childId: child.matricule,
              childName: child.fullName,
              timestamp: new Date().toISOString()
            };
            
            sendNotification(notification);
          }
        });
      });
    }

    // 4. Écouter les devoirs (primaire)
    if (child.type === 'primary') {
      const homeworkQuery = query(
        collection(db, 'homework'),
        where('className', '==', child.class)
      );
      
      onSnapshot(homeworkQuery, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === 'added') {
            const homework = change.doc.data();
            
            const notification = {
              title: '📚 Nouveau devoir primaire',
              body: `${child.fullName}: ${homework.subject} - ${homework.title}`,
              type: 'homework',
              page: 'homework',
              childId: child.matricule,
              childName: child.fullName,
              timestamp: new Date().toISOString()
            };
            
            sendNotification(notification);
          }
        });
      });
    }

    // 5. Écouter les devoirs (maternelle)
    if (child.type === 'kindergarten') {
      const homeworkQuery = query(
        collection(db, 'kindergarten_homework'),
        where('className', '==', child.class)
      );
      
      onSnapshot(homeworkQuery, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === 'added') {
            const homework = change.doc.data();
            
            const notification = {
              title: '🎨 Nouvelle activité maternelle',
              body: `${child.fullName}: ${homework.title}`,
              type: 'homework',
              page: 'homework',
              childId: child.matricule,
              childName: child.fullName,
              timestamp: new Date().toISOString()
            };
            
            sendNotification(notification);
          }
        });
      });
    }

    // 6. Écouter les présences
    const today = new Date().toISOString().split('T')[0];
    const presenceQuery = query(
      collection(db, 'student_attendance'),
      where('studentId', '==', child.matricule),
      where('date', '==', today)
    );
    
    onSnapshot(presenceQuery, (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'added') {
          const presence = change.doc.data();
          
          let statusText = '';
          if (presence.status === 'present') statusText = 'est présent';
          else if (presence.status === 'absent') statusText = 'est absent';
          else if (presence.status === 'late') statusText = 'est en retard';
          
          if (statusText) {
            const notification = {
              title: '📅 Présence enregistrée',
              body: `${child.fullName} ${statusText} aujourd'hui`,
              type: 'presence',
              page: 'presence-incidents',
              childId: child.matricule,
              childName: child.fullName,
              timestamp: new Date().toISOString()
            };
            
            sendNotification(notification);
          }
        }
      });
    });

    // 7. Écouter les cotes primaires
    if (child.type === 'primary') {
      const primaryGradesQuery = query(
        collection(db, 'primary_published_grades'),
        where('studentId', '==', child.matricule)
      );
      
      onSnapshot(primaryGradesQuery, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === 'added') {
            const gradeData = change.doc.data();
            
            const notification = {
              title: '📈 Nouvelle cote primaire',
              body: `Une nouvelle cote a été publiée pour ${child.fullName}`,
              type: 'grades',
              page: 'grades',
              childId: child.matricule,
              childName: child.fullName,
              timestamp: new Date().toISOString()
            };
            
            sendNotification(notification);
          }
        });
      });
    }
  });

  // 8. Écouter les communiqués
  const communiquesQuery = query(
    collection(db, 'parent_communique_relations'),
    where('parentId', '==', currentParent.matricule)
  );
  
  onSnapshot(communiquesQuery, (snapshot) => {
    snapshot.docChanges().forEach((change) => {
      if (change.type === 'added') {
        const notification = {
          title: '📄 Nouveau communiqué',
          body: 'Un nouveau communiqué de paiement est disponible',
          type: 'communiques',
          page: 'communiques',
          timestamp: new Date().toISOString()
        };
        
        sendNotification(notification);
      }
    });
  });

  // 9. Écouter les horaires
  const timetableQuery = query(
    collection(db, 'student_schedules'),
    where('studentMatricule', '==', currentParent.matricule)
  );
  
  onSnapshot(timetableQuery, (snapshot) => {
    snapshot.docChanges().forEach((change) => {
      if (change.type === 'added') {
        const notification = {
          title: '🕐 Nouvel horaire',
          body: 'Un nouvel horaire a été publié pour votre enfant',
          type: 'timetable',
          page: 'timetable',
          timestamp: new Date().toISOString()
        };
        
        sendNotification(notification);
      }
    });
  });
}

// ============================================
// ENVOYER UNE NOTIFICATION
// ============================================
function sendNotification(notification) {
  // 1. Ajouter à la liste locale
  notifications.unshift({
    id: `notif_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
    ...notification,
    read: false
  });
  
  // 2. Mettre à jour le compteur
  updateNotificationCount(1);
  
  // 3. Sauvegarder dans le stockage local
  saveNotificationsToStorage();
  
  // 4. Afficher une notification toast
  showNotificationToast(notification);
  
  // 5. Envoyer au Service Worker pour affichage même si app fermée
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({
      type: 'BACKGROUND_NOTIFICATION',
      data: notification
    });
  }
  
  // 6. Mettre à jour le badge de l'application
  updateAppBadge(notifications.filter(n => !n.read).length);
  
  // 7. Jouer un son si disponible
  try {
    const audio = new Audio('/notification.mp3');
    audio.volume = 0.5;
    audio.play().catch(() => {});
  } catch (e) {}
}

// ============================================
// METTRE À JOUR LE BADGE DE L'APPLICATION
// ============================================
async function updateAppBadge(count) {
  if (!('setAppBadge' in navigator)) return;
  
  try {
    if (count > 0) {
      await navigator.setAppBadge(count);
    } else {
      await navigator.clearAppBadge();
    }
  } catch (error) {
    console.error('❌ Erreur mise à jour badge:', error);
  }
}

// ============================================
// AFFICHER UN TOAST DE NOTIFICATION
// ============================================
function showNotificationToast(notification) {
  const toast = document.createElement('div');
  toast.className = `notification-toast ${notification.type}`;
  toast.innerHTML = `
    <div class="notification-header">
      <div class="notification-title">${notification.title}</div>
      <button class="notification-close">&times;</button>
    </div>
    <div class="notification-body">${notification.body}</div>
    <div class="notification-actions">
      <button class="btn btn-primary btn-sm" onclick="window.viewNotification('${notification.id}')">Voir</button>
      <button class="btn btn-secondary btn-sm" onclick="window.closeNotificationToast(this)">Fermer</button>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  toast.querySelector('.notification-close').addEventListener('click', () => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  });
  
  setTimeout(() => {
    if (toast.parentNode) {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }
  }, 8000);
}

// ============================================
// ÉCOUTER LES MESSAGES EN PREMIER PLAN
// ============================================
function setupForegroundListener() {
  if (!messaging) return;
  
  onMessage(messaging, (payload) => {
    console.log('📨 Message reçu en premier plan:', payload);
    
    const { title, body } = payload.notification || {};
    const data = payload.data || {};
    
    sendNotification({
      title: title || 'Nouvelle notification',
      body: body || '',
      type: data.type || 'general',
      page: data.page || 'dashboard',
      childId: data.childId,
      childName: data.childName,
      timestamp: new Date().toISOString()
    });
  });
}

// ============================================
// INITIALISATION COMPLÈTE
// ============================================
async function initializeCompleteNotificationSystem() {
  await registerServiceWorker();
  await initializeFirebaseMessaging();
  setupForegroundListener();
  
  setInterval(checkForNewData, 5 * 60 * 1000);
  window.addEventListener('online', checkForNewData);
}

// ============================================
// VÉRIFIER LES NOUVELLES DONNÉES
// ============================================
async function checkForNewData() {
  if (!currentParent || childrenList.length === 0) return;
  console.log('🔍 Vérification périodique des nouvelles données...');
}

// ============================================
// FONCTIONS UTILITAIRES
// ============================================
function updateNotificationCount(change) {
  const countElement = document.getElementById('notification-count');
  if (!countElement) return;
  
  let currentCount = parseInt(countElement.textContent) || 0;
  currentCount += change;
  if (currentCount < 0) currentCount = 0;
  
  countElement.textContent = currentCount;
  countElement.classList.toggle('hidden', currentCount === 0);
}

function saveNotificationsToStorage() {
  try {
    if (notifications.length > 50) {
      notifications = notifications.slice(0, 50);
    }
    localStorage.setItem('parent_notifications', JSON.stringify(notifications));
  } catch (error) {
    console.error('Erreur sauvegarde notifications:', error);
  }
}

function loadNotificationsFromStorage() {
  try {
    const saved = localStorage.getItem('parent_notifications');
    if (saved) {
      notifications = JSON.parse(saved);
      const unreadCount = notifications.filter(n => !n.read).length;
      updateNotificationCount(unreadCount);
      updateAppBadge(unreadCount);
    }
  } catch (error) {
    console.error('Erreur chargement notifications:', error);
  }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `notification-toast ${type}`;
    toast.innerHTML = `
        <div class="notification-header">
            <div class="notification-title">${type === 'success' ? '✅ Succès' : type === 'error' ? '❌ Erreur' : type === 'warning' ? '⚠️ Attention' : 'ℹ️ Information'}</div>
            <button class="notification-close">&times;</button>
        </div>
        <div class="notification-body">${message}</div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    toast.querySelector('.notification-close').addEventListener('click', () => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    });
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

function showAlert(message, type = 'info') {
    const alertBox = document.getElementById('global-alert');
    alertBox.textContent = message;
    alertBox.className = `alert alert-${type}`;
    alertBox.classList.remove('hidden');
    setTimeout(() => alertBox.classList.add('hidden'), 6000);
}

function showLoading(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.classList.remove('hidden');
    }
}

function hideLoading(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.classList.add('hidden');
    }
}

function getMonthName(monthIndex) {
    const months = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
    return months[monthIndex];
}

function getIncidentTypeLabel(type) {
    const types = {
        'retard': 'Retard',
        'absenteisme': 'Absentéisme',
        'comportement': 'Problème de comportement',
        'autre': 'Autre incident'
    };
    return types[type] || type;
}

function getSeverityLabel(severity) {
    const severities = {
        'faible': 'Faible',
        'moyen': 'Moyen',
        'eleve': 'Élevé'
    };
    return severities[severity] || severity;
}

function generatePaymentCode() {
    return 'PAY' + Math.random().toString(36).substring(2, 6).toUpperCase();
}

function getPeriodNameForParent(period) {
    const periodNames = {
        'P1': 'Première Période',
        'P2': 'Deuxième Période',
        'EXAM_S1': 'Examen Semestre 1',
        'TOTAL_S1': 'Total Semestre 1',
        'P3': 'Troisième Période',
        'P4': 'Quatrième Période',
        'EXAM_S2': 'Examen Semestre 2',
        'TOTAL_S2': 'Total Semestre 2',
        'TOTAL_GENERAL': 'Total Général'
    };
    return periodNames[period] || period;
}

function getPeriodCalculationInfoForParent(period) {
    switch(period) {
        case 'TOTAL_S1':
            return 'Calcul: Total S1 = P1 + P2 + EXAM_S1';
        case 'TOTAL_S2':
            return 'Calcul: Total S2 = P3 + P4 + EXAM_S2';
        case 'TOTAL_GENERAL':
            return 'Calcul: Total Général = Moyenne(Total S1, Total S2)';
        default:
            return 'Cotes directes pour cette période';
    }
}

// ============================================
// FONCTIONS EXPOSÉES GLOBALEMENT
// ============================================
window.viewNotification = function(id) {
  const notification = notifications.find(n => n.id === id);
  if (notification) {
    if (!notification.read) {
      notification.read = true;
      updateNotificationCount(-1);
      saveNotificationsToStorage();
      updateAppBadge(notifications.filter(n => !n.read).length);
    }
    
    if (notification.page) {
      const link = document.querySelector(`.nav-menu a[data-page="${notification.page}"]`);
      if (link) link.click();
    }
  }
};

window.closeNotificationToast = function(btn) {
  const toast = btn.closest('.notification-toast');
  toast.classList.remove('show');
  setTimeout(() => toast.remove(), 300);
};

window.requestNotificationPermission = async function() {
  const permission = await Notification.requestPermission();
  if (permission === 'granted') {
    await initializeFirebaseMessaging();
    return true;
  }
  return false;
};

window.testNotification = function() {
  sendNotification({
    title: '🔔 Test réussi',
    body: 'Les notifications fonctionnent parfaitement !',
    type: 'test',
    page: 'dashboard',
    timestamp: new Date().toISOString()
  });
};

window.markNotificationAsRead = function(id) {
    const notification = notifications.find(n => n.id === id);
    if (notification && !notification.read) {
        notification.read = true;
        updateNotificationCount(-1);
        saveNotificationsToStorage();
        updateAppBadge(notifications.filter(n => !n.read).length);
        
        if (document.getElementById('notifications-page').classList.contains('active')) {
            displayNotifications(document.getElementById('notification-filter').value);
        }
        
        showToast('Notification marquée comme lue', 'success');
    }
};

window.viewNotification = function(id) {
    const notification = notifications.find(n => n.id === id);
    if (notification) {
        if (!notification.read) {
            window.markNotificationAsRead(id);
        }
        
        if (notification.data && notification.data.page) {
            const link = document.querySelector(`.nav-menu a[data-page="${notification.data.page}"]`);
            if (link) link.click();
        }
        
        showToast('Ouverture de la notification', 'info');
    }
};

window.deleteNotification = function(id) {
    const index = notifications.findIndex(n => n.id === id);
    if (index !== -1) {
        const wasUnread = !notifications[index].read;
        notifications.splice(index, 1);
        
        if (wasUnread) {
            updateNotificationCount(-1);
        }
        
        saveNotificationsToStorage();
        
        if (document.getElementById('notifications-page').classList.contains('active')) {
            displayNotifications(document.getElementById('notification-filter').value);
        }
        
        showToast('Notification supprimée', 'success');
    }
};

window.openNotification = function(id) {
    window.viewNotification(id);
};

window.clearAllNotifications = function() {
    if (notifications.length === 0) {
        showToast('Aucune notification à effacer', 'info');
        return;
    }
    
    if (confirm('Voulez-vous vraiment effacer toutes les notifications ?')) {
        const unreadCount = notifications.filter(n => !n.read).length;
        notifications = [];
        updateNotificationCount(-unreadCount);
        saveNotificationsToStorage();
        
        if (document.getElementById('notifications-page').classList.contains('active')) {
            displayNotifications();
        }
        
        showToast('Toutes les notifications ont été effacées', 'success');
    }
};

// ============================================
// FONCTION UPLOAD CLOUDINARY
// ============================================
async function uploadToCloudinary(file, folder = 'cs-lacolombe') {
    if (!file) return null;
    
    try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
        formData.append('folder', folder);
        formData.append('tags', 'school_management');
        
        const response = await fetch(
            `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/image/upload`,
            { method: 'POST', body: formData }
        );
        
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const data = await response.json();
        return data.secure_url;
        
    } catch (error) {
        console.error("❌ Erreur upload Cloudinary:", error);
        throw new Error(`Échec de l'upload Cloudinary: ${error.message}`);
    }
}

// ============================================
// GÉNÉRATION MATRICULE PARENT
// ============================================
async function generateParentMatricule() {
    try {
        const parentsQuery = query(collection(db, 'parents'));
        const parentsSnap = await getDocs(parentsQuery);
        
        let maxNumber = 0;
        
        parentsSnap.forEach(doc => {
            const matricule = doc.data().matricule;
            if (matricule && matricule.startsWith('P')) {
                const numberPart = matricule.substring(1);
                const number = parseInt(numberPart);
                if (!isNaN(number) && number > maxNumber) {
                    maxNumber = number;
                }
            }
        });
        
        const newNumber = maxNumber + 1;
        return 'P' + newNumber.toString().padStart(3, '0');
        
    } catch (error) {
        console.error("Erreur génération matricule parent:", error);
        return 'P' + Math.floor(Math.random() * 900 + 100).toString();
    }
}

// ============================================
// AUTH STATE CHANGED
// ============================================
onAuthStateChanged(auth, async (user) => {
  if (user) {
    const q = query(collection(db, 'parents'), where('uid', '==', user.uid));
    const snap = await getDocs(q);
    
    if (!snap.empty) {
      currentParent = { id: snap.docs[0].id, ...snap.docs[0].data() };
      
      document.getElementById('login-overlay').classList.add('hidden');
      document.getElementById('app-root').classList.remove('hidden');
      document.getElementById('parent-name').textContent = currentParent.fullName;
      
      if (currentParent.photoURL) {
          document.getElementById('parent-photo-container').innerHTML = `<img src="${currentParent.photoURL}" class="parent-photo" alt="Photo de profil">`;
          document.getElementById('profile-photo-preview').innerHTML = `<img src="${currentParent.photoURL}" class="photo-preview">`;
      } else {
          document.getElementById('parent-photo-container').innerHTML = `<div class="parent-photo-placeholder"><i class="fas fa-user"></i></div>`;
      }
      
      loadNotificationsFromStorage();
      await loadParentData();
      
      initializeCompleteNotificationSystem();
      setupRealtimeListeners();
      
      const unreadCount = notifications.filter(n => !n.read).length;
      updateAppBadge(unreadCount);
      document.getElementById('notification-count').textContent = unreadCount;
      if (unreadCount > 0) {
        document.getElementById('notification-count').classList.remove('hidden');
      }
    } else {
      await signOut(auth);
      showAlert("Accès refusé.", "error");
    }
  } else {
    document.getElementById('login-overlay').classList.remove('hidden');
    document.getElementById('app-root').classList.add('hidden');
  }
});

// ============================================
// FONCTIONS D'ACTIVATION DE COMPTE
// ============================================
document.getElementById('show-activation-link').addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('login-form').closest('.login-card').classList.add('hidden');
    document.getElementById('activation-card').classList.remove('hidden');
});

document.getElementById('show-login-link').addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('activation-card').classList.add('hidden');
    document.getElementById('login-form').closest('.login-card').classList.remove('hidden');
    resetActivationForm();
});

document.getElementById('back-to-step1').addEventListener('click', (e) => {
    e.preventDefault();
    goToActivationStep(1);
});

document.getElementById('go-to-login-btn').addEventListener('click', () => {
    document.getElementById('activation-card').classList.add('hidden');
    document.getElementById('login-form').closest('.login-card').classList.remove('hidden');
    resetActivationForm();
});

function goToActivationStep(step) {
    document.querySelectorAll('.step').forEach((el, index) => {
        if (index + 1 < step) {
            el.classList.add('completed');
            el.classList.remove('active');
        } else if (index + 1 === step) {
            el.classList.add('active');
            el.classList.remove('completed');
        } else {
            el.classList.remove('active', 'completed');
        }
    });
    
    document.getElementById('activation-step-1').classList.toggle('hidden', step !== 1);
    document.getElementById('activation-step-2').classList.toggle('hidden', step !== 2);
    document.getElementById('activation-step-3').classList.toggle('hidden', step !== 3);
}

function resetActivationForm() {
    document.getElementById('activation-form-step1').reset();
    document.getElementById('activation-step-2').classList.add('hidden');
    document.getElementById('activation-step-3').classList.add('hidden');
    document.getElementById('additional-matricule').value = '';
    verifiedChildren = [];
    updateChildrenList();
    goToActivationStep(1);
}

function updateChildrenList() {
    const container = document.getElementById('children-container');
    container.innerHTML = '';
    
    if (verifiedChildren.length === 0) {
        container.innerHTML = '<p>Aucun enfant ajouté</p>';
        return;
    }
    
    verifiedChildren.forEach((child, index) => {
        const childElement = document.createElement('div');
        childElement.className = 'child-item';
        childElement.innerHTML = `
            <div class="child-header">
                <strong>${child.name}</strong>
                <div class="child-actions">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeChild(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div>Matricule: ${child.matricule}</div>
            <div>Classe: ${child.class}</div>
            <div>Type: ${child.type === 'secondary' ? 'Secondaire' : child.type === 'primary' ? 'Primaire' : 'Maternelle'}</div>
        `;
        container.appendChild(childElement);
    });
}

window.removeChild = (index) => {
    verifiedChildren.splice(index, 1);
    updateChildrenList();
};

// Étape 1: Vérification du premier matricule
document.getElementById('activation-form-step1').addEventListener('submit', async (e) => {
    e.preventDefault();
    const childMatricule = document.getElementById('child-matricule').value;
    
    if (!childMatricule) {
        showAlert("Veuillez entrer un matricule d'élève", "error");
        return;
    }
    
    try {
        let studentData = null;
        let studentType = null;
        
        let studentDoc = await getDoc(doc(db, 'students', childMatricule));
        if (studentDoc.exists()) {
            studentData = studentDoc.data();
            studentType = 'secondary';
        } else {
            studentDoc = await getDoc(doc(db, 'primary_students', childMatricule));
            if (studentDoc.exists()) {
                studentData = studentDoc.data();
                studentType = 'primary';
            } else {
                studentDoc = await getDoc(doc(db, 'kindergarten_students', childMatricule));
                if (studentDoc.exists()) {
                    studentData = studentDoc.data();
                    studentType = 'kindergarten';
                }
            }
        }
        
        if (!studentData) {
            showAlert("Aucun élève trouvé avec ce matricule", "error");
            return;
        }
        
        if (studentData.parentId) {
            showAlert("Cet élève est déjà associé à un compte parent", "error");
            return;
        }
        
        verifiedChildren = [{
            matricule: childMatricule,
            name: studentData.fullName,
            class: studentData.class,
            type: studentType
        }];
        
        document.getElementById('child-name').textContent = studentData.fullName;
        document.getElementById('child-class').textContent = studentData.class;
        updateChildrenList();
        goToActivationStep(2);
        
    } catch (error) {
        console.error("Erreur vérification matricule:", error);
        showAlert("Erreur lors de la vérification du matricule: " + error.message, "error");
    }
});

// Ajouter un autre enfant
document.getElementById('add-child-btn').addEventListener('click', async () => {
    const matricule = document.getElementById('additional-matricule').value;
    
    if (!matricule) {
        showAlert("Veuillez entrer un matricule", "error");
        return;
    }
    
    try {
        let studentData = null;
        let studentType = null;
        
        let studentDoc = await getDoc(doc(db, 'students', matricule));
        if (studentDoc.exists()) {
            studentData = studentDoc.data();
            studentType = 'secondary';
        } else {
            studentDoc = await getDoc(doc(db, 'primary_students', matricule));
            if (studentDoc.exists()) {
                studentData = studentDoc.data();
                studentType = 'primary';
            } else {
                studentDoc = await getDoc(doc(db, 'kindergarten_students', matricule));
                if (studentDoc.exists()) {
                    studentData = studentDoc.data();
                    studentType = 'kindergarten';
                }
            }
        }
        
        if (!studentData) {
            showAlert("Aucun élève trouvé avec ce matricule", "error");
            return;
        }
        
        if (studentData.parentId) {
            showAlert("Cet élève est déjà associé à un compte parent", "error");
            return;
        }
        
        if (verifiedChildren.find(child => child.matricule === matricule)) {
            showAlert("Cet élève est déjà dans la liste", "error");
            return;
        }
        
        verifiedChildren.push({
            matricule: matricule,
            name: studentData.fullName,
            class: studentData.class,
            type: studentType
        });
        
        updateChildrenList();
        document.getElementById('additional-matricule').value = '';
        showAlert("Enfant ajouté avec succès", "success");
        
    } catch (error) {
        console.error("Erreur ajout enfant:", error);
        showAlert("Erreur lors de l'ajout de l'enfant: " + error.message, "error");
    }
});

// Création du compte parent
document.getElementById('create-account-btn').addEventListener('click', async () => {
    const fullName = document.getElementById('parent-fullname').value;
    const email = document.getElementById('parent-email').value;
    const phone = document.getElementById('parent-phone').value;
    const password = document.getElementById('parent-password').value;
    const confirmPassword = document.getElementById('parent-password-confirm').value;
    
    if (!fullName || !email || !phone || !password) {
        showAlert("Veuillez remplir tous les champs obligatoires", "error");
        return;
    }
    
    if (password !== confirmPassword) {
        showAlert("Les mots de passe ne correspondent pas", "error");
        return;
    }
    
    if (password.length < 6) {
        showAlert("Le mot de passe doit contenir au moins 6 caractères", "error");
        return;
    }
    
    if (verifiedChildren.length === 0) {
        showAlert("Veuillez ajouter au moins un enfant", "error");
        return;
    }
    
    try {
        const parentMatricule = await generateParentMatricule();
        const parentEmail = `parent.${parentMatricule}@cs-lacolombe.edu`;
        const userCredential = await createUserWithEmailAndPassword(auth, parentEmail, password);
        const user = userCredential.user;
        
        const parentData = {
            matricule: parentMatricule,
            fullName: fullName,
            email: email,
            phone: phone,
            authEmail: parentEmail,
            uid: user.uid,
            children: verifiedChildren.map(child => ({
                matricule: child.matricule,
                type: child.type
            })),
            notificationEnabled: false,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
        };
        
        const parentRef = doc(db, 'parents', parentMatricule);
        await setDoc(parentRef, parentData);
        
        for (const child of verifiedChildren) {
            let studentRef;
            if (child.type === 'secondary') {
                studentRef = doc(db, 'students', child.matricule);
            } else if (child.type === 'primary') {
                studentRef = doc(db, 'primary_students', child.matricule);
            } else {
                studentRef = doc(db, 'kindergarten_students', child.matricule);
            }
            
            await updateDoc(studentRef, {
                parentId: parentMatricule,
                parentName: fullName,
                parentEmail: email,
                parentPhone: phone,
                updatedAt: serverTimestamp()
            });
        }
        
        document.getElementById('created-parent-matricule').textContent = parentMatricule;
        document.getElementById('created-parent-name').textContent = fullName;
        document.getElementById('created-parent-email').textContent = email;
        document.getElementById('created-children-count').textContent = verifiedChildren.length;
        goToActivationStep(3);
        
    } catch (error) {
        console.error("Erreur création compte:", error);
        showAlert("Erreur lors de la création du compte: " + error.message, "error");
    }
});

// Connexion avec matricule parent
document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const matricule = document.getElementById('login-matricule').value;
    const password = document.getElementById('login-password').value;
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Connexion...';
    submitBtn.disabled = true;

    try {
        const parentDoc = await getDoc(doc(db, 'parents', matricule));
        if (!parentDoc.exists()) {
            showAlert("Matricule parent incorrect", "error");
            return;
        }
        
        const parentData = parentDoc.data();
        const authEmail = parentData.authEmail;
        
        await signInWithEmailAndPassword(auth, authEmail, password);
        
    } catch (error) {
        console.error("Erreur connexion:", error);
        showAlert("Matricule ou mot de passe incorrect", "error");
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

document.getElementById('logout-btn').addEventListener('click', () => {
    signOut(auth);
    showAlert("Déconnexion réussie", "success");
});

// ============================================
// CHARGEMENT DES DONNÉES PARENT
// ============================================
async function loadParentData() {
    const childSelectors = [
        document.getElementById('child-selector'), 
        document.getElementById('presence-child-selector'),
        document.getElementById('payment-child-selector'),
        document.getElementById('timetable-child-selector')
    ];
    
    const secondarySelectors = [
        document.getElementById('secondary-grades-child-selector'),
        document.getElementById('secondary-homework-child-selector')
    ];
    
    const primarySelectors = [
        document.getElementById('primary-grades-child-selector'),
        document.getElementById('primary-homework-child-selector')
    ];
    
    const kindergartenSelectors = [
        document.getElementById('kindergarten-grades-child-selector'),
        document.getElementById('kindergarten-homework-child-selector')
    ];
    
    childSelectors.forEach(s => s.innerHTML = '<option value="">-- Sélectionner un enfant --</option>');
    secondarySelectors.forEach(s => s.innerHTML = '<option value="">-- Sélectionner un enfant du secondaire --</option>');
    primarySelectors.forEach(s => s.innerHTML = '<option value="">-- Sélectionner un enfant du primaire --</option>');
    kindergartenSelectors.forEach(s => s.innerHTML = '<option value="">-- Sélectionner un enfant de la maternelle --</option>');

    if (currentParent && currentParent.children) {
        childrenList = [];
        
        for (const childData of currentParent.children) {
            const childMatricule = childData.matricule || childData;
            const childType = childData.type || 'secondary';
            
            let childDoc;
            if (childType === 'secondary') {
                childDoc = await getDoc(doc(db, 'students', childMatricule));
            } else if (childType === 'primary') {
                childDoc = await getDoc(doc(db, 'primary_students', childMatricule));
            } else {
                childDoc = await getDoc(doc(db, 'kindergarten_students', childMatricule));
            }
            
            if (childDoc.exists()) {
                const childInfo = childDoc.data();
                const childObj = {
                    matricule: childMatricule,
                    type: childType,
                    ...childInfo
                };
                childrenList.push(childObj);
                
                const displayText = `${childInfo.fullName} - ${childInfo.class} (${childType === 'secondary' ? 'Secondaire' : childType === 'primary' ? 'Primaire' : 'Maternelle'})`;
                
                childSelectors.forEach(s => s.innerHTML += `<option value="${childMatricule}">${displayText}</option>`);
                
                if (childType === 'secondary') {
                    secondarySelectors.forEach(s => s.innerHTML += `<option value="${childMatricule}">${childInfo.fullName} - ${childInfo.class}</option>`);
                } else if (childType === 'primary') {
                    primarySelectors.forEach(s => s.innerHTML += `<option value="${childMatricule}">${childInfo.fullName} - ${childInfo.class}</option>`);
                } else {
                    kindergartenSelectors.forEach(s => s.innerHTML += `<option value="${childMatricule}">${childInfo.fullName} - ${childInfo.class}</option>`);
                }
            }
        }
        
        updateChildrenPage();
        updateProfileForm();
        loadYearSelectors();
        setupHomeworkTabs();
        setupPrimaryPeriods();
        setupSecondaryGradesPeriods();
        setupSubTabs();
        initCommuniqueSelectors();
    }
}

function updateChildrenPage() {
    const container = document.getElementById('children-list-container');
    container.innerHTML = '';
    
    if (childrenList.length === 0) {
        container.innerHTML = '<p>Aucun enfant associé à votre compte</p>';
        return;
    }
    
    childrenList.forEach(child => {
        const childElement = document.createElement('div');
        childElement.className = 'child-item';
        childElement.innerHTML = `
            <div class="child-header">
                <strong>${child.fullName}</strong>
            </div>
            <div>Matricule: ${child.matricule}</div>
            <div>Classe: ${child.class}</div>
            <div>Type: ${child.type === 'secondary' ? 'Secondaire' : child.type === 'primary' ? 'Primaire' : 'Maternelle'}</div>
            <div>Date de naissance: ${child.birthdate || 'Non spécifiée'}</div>
        `;
        container.appendChild(childElement);
    });
}

function updateProfileForm() {
    if (currentParent) {
        document.getElementById('profile-matricule').value = currentParent.matricule;
        document.getElementById('profile-fullname').value = currentParent.fullName;
        document.getElementById('profile-email').value = currentParent.email;
        document.getElementById('profile-phone').value = currentParent.phone;
        
        const statusElement = document.getElementById('notification-status');
        if (currentParent.notificationEnabled) {
            statusElement.textContent = '✅ Notifications activées';
            statusElement.style.color = 'var(--success)';
        } else {
            statusElement.textContent = '❌ Notifications désactivées';
            statusElement.style.color = 'var(--danger)';
        }
    }
}

function loadYearSelectors() {
    const currentYear = new Date().getFullYear();
    const yearSelectors = document.querySelectorAll('#presence-year');
    
    yearSelectors.forEach(select => {
        select.innerHTML = '';
        for (let year = currentYear - 1; year <= currentYear + 1; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            if (year === currentYear) option.selected = true;
            select.appendChild(option);
        }
    });
    
    const currentMonth = new Date().getMonth();
    document.getElementById('presence-month').value = currentMonth;
    
    const today = new Date();
    const year = today.getFullYear();
    const month = (today.getMonth() + 1).toString().padStart(2, '0');
    const monthString = `${year}-${month}`;
    document.getElementById('timetable-month').value = monthString;
}

// ============================================
// FONCTIONS POUR LES COMMUNIQUÉS
// ============================================
function initCommuniqueSelectors() {
    const childSelector = document.getElementById('communique-child-selector');
    childSelector.innerHTML = '<option value="all">Tous mes enfants</option>';
    
    childrenList.forEach(child => {
        const displayText = `${child.fullName} - ${child.class} (${child.type === 'secondary' ? 'Sec' : child.type === 'primary' ? 'Prim' : 'Mat'})`;
        childSelector.innerHTML += `<option value="${child.matricule}">${displayText}</option>`;
    });
    
    childSelector.addEventListener('change', () => loadCommuniques());
    document.getElementById('communique-type-filter').addEventListener('change', () => loadCommuniques());
    document.getElementById('refresh-communiques-btn').addEventListener('click', () => loadCommuniques());
}

async function loadCommuniques() {
    const container = document.getElementById('communiques-list-container');
    container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Chargement des communiqués...</p></div>';
    
    if (!currentParent || childrenList.length === 0) {
        container.innerHTML = '<div class="no-data"><i class="fas fa-newspaper"></i><p>Aucun enfant associé à votre compte.</p></div>';
        return;
    }
    
    try {
        const parentCommuniquesQuery = query(
            collection(db, 'parent_communique_relations'),
            where('parentId', '==', currentParent.matricule),
            orderBy('createdAt', 'desc')
        );
        
        const parentCommuniquesSnap = await getDocs(parentCommuniquesQuery);
        
        if (parentCommuniquesSnap.empty) {
            container.innerHTML = '<div class="no-data"><i class="fas fa-newspaper"></i><p>Aucun communiqué reçu pour le moment.</p></div>';
            return;
        }
        
        let allCommuniques = [];
        
        for (const relationDoc of parentCommuniquesSnap.docs) {
            const relationData = relationDoc.data();
            const communiqueId = relationData.communiqueId;
            
            const communiqueDoc = await getDoc(doc(db, 'parent_communiques', communiqueId));
            
            if (communiqueDoc.exists()) {
                const communiqueData = communiqueDoc.data();
                
                allCommuniques.push({
                    id: communiqueId,
                    ...communiqueData,
                    relationId: relationDoc.id,
                    parentRelation: relationData,
                    affectedChildren: relationData.studentIds.map((studentId, index) => ({
                        matricule: studentId,
                        name: relationData.studentNames[index] || 'Nom inconnu',
                        class: relationData.studentClasses[index] || 'Classe inconnue'
                    }))
                });
            }
        }
        
        if (allCommuniques.length === 0) {
            container.innerHTML = '<div class="no-data"><i class="fas fa-newspaper"></i><p>Aucun communiqué disponible pour le moment.</p></div>';
            return;
        }
        
        const selectedChild = document.getElementById('communique-child-selector').value;
        const selectedType = document.getElementById('communique-type-filter').value;
        
        let filteredCommuniques = allCommuniques;
        
        if (selectedChild !== 'all') {
            filteredCommuniques = filteredCommuniques.filter(communique => 
                communique.parentRelation.studentIds.includes(selectedChild)
            );
        }
        
        if (selectedType !== 'all') {
            filteredCommuniques = filteredCommuniques.filter(communique => 
                communique.feeType === selectedType
            );
        }
        
        if (filteredCommuniques.length === 0) {
            container.innerHTML = '<div class="no-data"><i class="fas fa-filter"></i><p>Aucun communiqué correspondant aux filtres sélectionnés.</p></div>';
            return;
        }
        
        let html = '';
        
        filteredCommuniques.forEach((communique, index) => {
            const publishedDate = communique.publishedAt ? 
                new Date(communique.publishedAt.toDate()).toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Date inconnue';
            
            const deadlineDate = new Date(communique.deadline);
            const now = new Date();
            const daysDiff = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));
            const isUrgent = daysDiff <= 3 && daysDiff >= 0;
            const isOverdue = daysDiff < 0;
            const isPaid = communique.parentRelation.status === 'paid';
            
            let cardClass = 'communique-card';
            if (isOverdue) cardClass += ' urgent';
            else if (isUrgent) cardClass += ' urgent';
            if (isPaid) cardClass += ' paid';
            
            let statusBadge = '';
            if (isOverdue) {
                statusBadge = '<span class="badge badge-danger">En retard</span>';
            } else if (isUrgent) {
                statusBadge = '<span class="badge badge-warning">Urgent</span>';
            } else if (isPaid) {
                statusBadge = '<span class="badge badge-success">Payé</span>';
            } else {
                statusBadge = '<span class="badge badge-info">En attente</span>';
            }
            
            let daysText = '';
            if (isOverdue) {
                daysText = `<span style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> Retard de ${Math.abs(daysDiff)} jour(s)</span>`;
            } else {
                daysText = `<span style="color: ${isUrgent ? 'var(--warning)' : 'var(--success)'};">⏱️ ${daysDiff} jour(s) restant(s)</span>`;
            }
            
            html += `
                <div class="${cardClass}">
                    <div class="communique-header">
                        <div style="flex: 1;">
                            <div class="communique-title">
                                ${communique.feeType} - ${communique.month} ${communique.schoolYear}
                            </div>
                            <div class="communique-meta">
                                <span><i class="far fa-calendar"></i> Publié le: ${publishedDate}</span>
                                <span><i class="far fa-clock"></i> Date limite: ${deadlineDate.toLocaleDateString('fr-FR')}</span>
                                <span>${statusBadge}</span>
                                <span>${daysText}</span>
                            </div>
                        </div>
                        <div>
                            <span class="badge badge-primary">
                                <i class="fas fa-money-bill-wave"></i> ${parseFloat(communique.amount).toFixed(2)} $
                            </span>
                        </div>
                    </div>
                    
                    <div class="communique-content">
                        <p><strong>Objet :</strong> Rappel concernant le paiement de <strong>${communique.feeType}</strong></p>
                        <p><strong>Enfants concernés :</strong> ${communique.affectedChildren.map(child => 
                            `<span class="badge badge-secondary">${child.name} (${child.matricule})</span>`
                        ).join(' ')}</p>
                        ${communique.message ? `<p><strong>Message :</strong> ${communique.message}</p>` : ''}
                    </div>
                    
                    <div class="communique-footer">
                        <div>
                            <strong>Classes concernées :</strong> ${communique.classes.join(', ')}
                        </div>
                        <div class="communique-actions">
                            <button class="btn btn-primary btn-sm" onclick="viewFullCommunique('${communique.id}')">
                                <i class="fas fa-eye"></i> Voir en détail
                            </button>
                            ${!isPaid ? `
                                <button class="btn btn-success btn-sm" onclick="markCommuniqueAsPaid('${communique.id}')">
                                    <i class="fas fa-check"></i> Marquer comme payé
                                </button>
                            ` : ''}
                            <button class="btn btn-info btn-sm" onclick="printCommuniqueForParent('${communique.id}')">
                                <i class="fas fa-print"></i> Imprimer
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Erreur chargement communiqués:', error);
        container.innerHTML = '<div class="no-data"><i class="fas fa-exclamation-triangle"></i><p>Erreur de chargement des communiqués. Veuillez réessayer.</p></div>';
    }
}

window.viewFullCommunique = async function(communiqueId) {
    console.log('🔍 Affichage communiqué:', communiqueId);
    
    try {
        const communiqueDoc = await getDoc(doc(db, 'parent_communiques', communiqueId));
        
        if (!communiqueDoc.exists()) {
            showAlert('Communiqué non trouvé.', 'error');
            return;
        }
        
        const communiqueData = communiqueDoc.data();
        
        const relationQuery = query(
            collection(db, 'parent_communique_relations'),
            where('parentId', '==', currentParent.matricule),
            where('communiqueId', '==', communiqueId)
        );
        
        const relationSnap = await getDocs(relationQuery);
        
        if (relationSnap.empty) {
            showAlert('Aucune relation trouvée pour ce communiqué.', 'error');
            return;
        }
        
        const relationData = relationSnap.docs[0].data();
        
        const selectedChild = document.getElementById('communique-child-selector').value;
        
        const childrenDetails = [];
        for (let i = 0; i < relationData.studentIds.length; i++) {
            const studentMatricule = relationData.studentIds[i];
            
            if (selectedChild && selectedChild !== 'all' && selectedChild !== studentMatricule) {
                continue;
            }
            
            let studentDoc = await getDoc(doc(db, 'students', studentMatricule));
            let studentType = 'secondary';
            
            if (!studentDoc.exists()) {
                studentDoc = await getDoc(doc(db, 'primary_students', studentMatricule));
                studentType = 'primary';
            }
            
            if (!studentDoc.exists()) {
                studentDoc = await getDoc(doc(db, 'kindergarten_students', studentMatricule));
                studentType = 'kindergarten';
            }
            
            if (studentDoc.exists()) {
                const studentData = studentDoc.data();
                childrenDetails.push({
                    matricule: studentMatricule,
                    name: studentData.fullName,
                    class: studentData.class,
                    type: studentType
                });
            }
        }
        
        if (childrenDetails.length === 0) {
            if (selectedChild && selectedChild !== 'all') {
                showAlert('Cet enfant n\'est pas concerné par ce communiqué.', 'warning');
            } else {
                showAlert('Aucun enfant trouvé pour ce communiqué.', 'error');
            }
            return;
        }
        
        const deadlineDate = new Date(communiqueData.deadline);
        const formattedDeadline = deadlineDate.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        const today = new Date();
        const formattedToday = today.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        let childrenHTML = '';
        childrenDetails.forEach((child, index) => {
            childrenHTML += `
                <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
                    <p><strong>Enfant ${index + 1}:</strong> ${child.name}</p>
                    <p><strong>Matricule:</strong> ${child.matricule}</p>
                    <p><strong>Classe:</strong> ${child.class} (${child.type === 'secondary' ? 'Secondaire' : child.type === 'primary' ? 'Primaire' : 'Maternelle'})</p>
                </div>
            `;
        });
        
        const montantParEnfant = selectedChild && selectedChild !== 'all' 
            ? parseFloat(communiqueData.amount).toFixed(2)
            : (parseFloat(communiqueData.amount) / childrenDetails.length).toFixed(2);
        
        const fullContentHTML = `
            <div class="communique-full-header">
                <img src="R.png" alt="Logo hybrilink" class="communique-full-logo">
                <div class="communique-full-title">COMMUNIQUE DE PAIEMENT</div>
                <div>hybrilink</div>
                <div>Lubumbashi, République Démocratique du Congo</div>
                <div>Tél: +243 097 187 758</div>
            </div>
            
            <div class="communique-full-date">
                Lubumbashi, le ${formattedToday}
            </div>
            
            <div style="margin-bottom: 2rem;">
                <p><strong>À l'attention de :</strong> ${currentParent.fullName}</p>
                <p><strong>Matricule parent :</strong> ${currentParent.matricule}</p>
                <p><strong>Email :</strong> ${currentParent.email}</p>
                <p><strong>Téléphone :</strong> ${currentParent.phone}</p>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <h4>Enfants concernés par ce communiqué :</h4>
                ${childrenHTML}
            </div>
            
            <div>
                <p><strong>Objet :</strong> Rappel concernant le paiement de <strong>${communiqueData.feeType}</strong></p>
                
                <p>Cher(s) parent(s), tuteur(s) légal(aux),</p>
                
                <p>L'établissement <strong>hybrilink</strong> vous adresse ce communiqué concernant le règlement de <strong>${communiqueData.feeType}</strong> pour l'année scolaire <strong>${communiqueData.schoolYear}</strong>.</p>
                
                <p>Nous vous rappelons que la date limite pour le paiement du solde de <strong>${communiqueData.feeType}</strong> pour le mois de <strong>${communiqueData.month}</strong> est fixée au <strong>${formattedDeadline}</strong>.</p>
                
                <p><strong>Détail des montants dus :</strong></p>
                
                <ul>
                    ${selectedChild && selectedChild !== 'all'
                        ? `<li>Frais de ${communiqueData.feeType.toLowerCase()} pour ${childrenDetails[0].name} : <strong>$${montantParEnfant}</strong></li>`
                        : childrenDetails.map((child, index) => 
                            `<li>Frais de ${communiqueData.feeType.toLowerCase()} pour ${child.name} (${child.class}) : <strong>$${montantParEnfant}</strong></li>`
                        ).join('')
                    }
                    ${childrenDetails.length > 1 && (!selectedChild || selectedChild === 'all')
                        ? `<li><strong>TOTAL :</strong> $${parseFloat(communiqueData.amount).toFixed(2)}</li>`
                        : ''
                    }
                </ul>
                
                ${communiqueData.message ? `<p><strong>Message additionnel :</strong> ${communiqueData.message}</p>` : ''}
                
                <p>Classes concernées par ce communiqué : ${communiqueData.classes.join(', ')}</p>
                
                <p>Nous vous remercions de votre compréhension et de votre collaboration.</p>
                
                <p>Bonne collaboration,<br>
                La Direction</p>
            </div>
            
            <div class="communique-full-signature">
                <p>Le Directeur</p>
                <div class="signature-line"></div>
            </div>
        `;
        
        document.getElementById('communique-full-content').innerHTML = fullContentHTML;
        
        window.currentCommuniqueForPrint = {
            id: communiqueId,
            data: communiqueData,
            children: childrenDetails,
            parent: currentParent,
            selectedChild: selectedChild,
            montantParEnfant: montantParEnfant
        };
        
        document.getElementById('communique-full-modal').classList.remove('hidden');
        
    } catch (error) {
        console.error('Erreur affichage communiqué:', error);
        showAlert('Erreur lors de l\'affichage du communiqué: ' + error.message, 'error');
    }
};

window.printCommuniqueForParent = async function(communiqueId) {
    try {
        const communiqueDoc = await getDoc(doc(db, 'parent_communiques', communiqueId));
        
        if (!communiqueDoc.exists()) {
            showAlert('Communiqué non trouvé.', 'error');
            return;
        }
        
        const communiqueData = communiqueDoc.data();
        
        const relationQuery = query(
            collection(db, 'parent_communique_relations'),
            where('parentId', '==', currentParent.matricule),
            where('communiqueId', '==', communiqueId)
        );
        
        const relationSnap = await getDocs(relationQuery);
        
        if (relationSnap.empty) {
            showAlert('Aucune relation trouvée.', 'error');
            return;
        }
        
        const relationData = relationSnap.docs[0].data();
        
        const childrenDetails = [];
        for (const studentMatricule of relationData.studentIds) {
            let studentDoc = await getDoc(doc(db, 'students', studentMatricule));
            if (!studentDoc.exists()) {
                studentDoc = await getDoc(doc(db, 'primary_students', studentMatricule));
            }
            if (!studentDoc.exists()) {
                studentDoc = await getDoc(doc(db, 'kindergarten_students', studentMatricule));
            }
            
            if (studentDoc.exists()) {
                const studentData = studentDoc.data();
                childrenDetails.push({
                    name: studentData.fullName,
                    matricule: studentMatricule,
                    class: studentData.class
                });
            }
        }
        
        const deadlineDate = new Date(communiqueData.deadline);
        const formattedDeadline = deadlineDate.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        const today = new Date();
        const formattedToday = today.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        const printHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Communiqué de paiement - CS la Colombe</title>
                <style>
                    body { font-family: 'Times New Roman', serif; margin: 40px; font-size: 14px; line-height: 1.6; }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #3498db; padding-bottom: 20px; }
                    .logo { max-width: 120px; margin-bottom: 10px; }
                    .title { font-size: 18px; font-weight: bold; margin: 15px 0; text-decoration: underline; }
                    .date { text-align: right; margin-bottom: 30px; font-style: italic; color: #666; }
                    .parent-info { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                    .children-info { margin: 20px 0; }
                    .child-card { background: #f1f8ff; padding: 10px; margin: 10px 0; border-left: 4px solid #3498db; border-radius: 0 5px 5px 0; }
                    .signature { margin-top: 100px; text-align: right; }
                    .signature-line { border-top: 1px solid #000; margin-top: 50px; width: 300px; margin-left: auto; }
                    strong { font-weight: bold; }
                    ul { padding-left: 20px; }
                    @media print { body { margin: 20px; } .no-print { display: none; } }
                </style>
            </head>
            <body>
                <div class="header">
                    <img src="R.png" alt="Logo CS la Colombe" class="logo">
                    <div class="title">COMMUNIQUE DE PAIEMENT</div>
                    <div>Complexe Scolaire la Colombe</div>
                    <div>Lubumbashi, République Démocratique du Congo</div>
                    <div>Tél: +243 XXX XXX XXX</div>
                </div>
                
                <div class="date">
                    Lubumbashi, le ${formattedToday}
                </div>
                
                <div class="parent-info">
                    <p><strong>À l'attention de :</strong> ${currentParent.fullName}</p>
                    <p><strong>Matricule parent :</strong> ${currentParent.matricule}</p>
                    <p><strong>Email :</strong> ${currentParent.email}</p>
                    <p><strong>Téléphone :</strong> ${currentParent.phone}</p>
                </div>
                
                <div class="children-info">
                    <h4>Enfants concernés par ce communiqué :</h4>
                    ${childrenDetails.map((child, index) => `
                        <div class="child-card">
                            <p><strong>Enfant ${index + 1}:</strong> ${child.name}</p>
                            <p><strong>Matricule :</strong> ${child.matricule}</p>
                            <p><strong>Classe :</strong> ${child.class}</p>
                        </div>
                    `).join('')}
                </div>
                
                <div>
                    <p><strong>Objet :</strong> Rappel concernant le paiement de <strong>${communiqueData.feeType}</strong></p>
                    
                    <p>Cher(s) parent(s), tuteur(s) légal(aux),</p>
                    
                    <p>L'établissement <strong>Complexe Scolaire la Colombe</strong> vous adresse ce communiqué concernant le règlement de <strong>${communiqueData.feeType}</strong> pour l'année scolaire <strong>${communiqueData.schoolYear}</strong>.</p>
                    
                    <p>Nous vous rappelons que la date limite pour le paiement du solde des frais de <strong>${communiqueData.feeType}</strong> pour le mois de <strong>${communiqueData.month}</strong> est fixée au <strong>${formattedDeadline}</strong>.</p>
                    
                    <p><strong>Détail des montants dus :</strong></p>
                    
                    <ul>
                        <li>Frais de ${communiqueData.feeType.toLowerCase()} : <strong>$${parseFloat(communiqueData.amount).toFixed(2)}</strong></li>
                    </ul>
                    
                    ${communiqueData.message ? `<p><strong>Message additionnel :</strong> ${communiqueData.message}</p>` : ''}
                    
                    <p>Classes concernées par ce communiqué : ${communiqueData.classes.join(', ')}</p>
                    
                    <p>Nous vous remercions de votre compréhension et de votre collaboration.</p>
                    
                    <p>Bonne collaboration,<br>
                    La Direction</p>
                </div>
                
                <div class="signature">
                    <p>Le Directeur</p>
                    <div class="signature-line"></div>
                </div>
                
                <div class="no-print" style="text-align: center; margin-top: 50px; color: #666; font-size: 12px;">
                    <p>Document généré automatiquement le ${new Date().toLocaleString('fr-FR')}</p>
                    <p>ID du communiqué: ${communiqueId}</p>
                </div>
                
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(function() {
                            window.close();
                        }, 1000);
                    }
                <\/script>
            </body>
            </html>
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printHTML);
        printWindow.document.close();
        
    } catch (error) {
        console.error('Erreur impression communiqué:', error);
        showAlert('Erreur lors de l\'impression: ' + error.message, 'error');
    }
};

window.markCommuniqueAsPaid = async function(communiqueId) {
    if (!confirm('Voulez-vous marquer ce communiqué comme payé ?')) {
        return;
    }
    
    try {
        const relationQuery = query(
            collection(db, 'parent_communique_relations'),
            where('parentId', '==', currentParent.matricule),
            where('communiqueId', '==', communiqueId)
        );
        
        const relationSnap = await getDocs(relationQuery);
        
        if (!relationSnap.empty) {
            const relationDoc = relationSnap.docs[0];
            await updateDoc(doc(db, 'parent_communique_relations', relationDoc.id), {
                status: 'paid',
                paidAt: serverTimestamp()
            });
        }
        
        for (const child of childrenList) {
            const studentRelationRef = doc(db, 'student_communique_relations', `${child.matricule}_${communiqueId}`);
            await updateDoc(studentRelationRef, {
                status: 'paid',
                paidAt: serverTimestamp()
            });
        }
        
        showAlert('Communiqué marqué comme payé avec succès.', 'success');
        
        loadCommuniques();
        
    } catch (error) {
        console.error('Erreur marquage communiqué:', error);
        showAlert('Erreur lors du marquage: ' + error.message, 'error');
    }
};

// ============================================
// FONCTIONS POUR LES PRÉSENCES ET INCIDENTS
// ============================================
document.getElementById('presence-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const content = document.getElementById('presence-incidents-content');
    if (!studentId) {
        content.classList.add('hidden');
        return;
    }
    content.classList.remove('hidden');
    loadChildIncidents(studentId);
});

document.getElementById('load-presence-btn').addEventListener('click', () => {
    const studentId = document.getElementById('presence-child-selector').value;
    const month = parseInt(document.getElementById('presence-month').value);
    const year = parseInt(document.getElementById('presence-year').value);
    
    if (!studentId) {
        showAlert("Veuillez sélectionner un enfant", "error");
        return;
    }
    
    loadChildMonthlyPresence(studentId, month, year);
});

async function loadChildMonthlyPresence(studentId, month, year) {
    const container = document.getElementById('monthly-presence-container');
    container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Chargement des présences...</p></div>';
    
    try {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        
        const startDate = firstDay.toISOString().split('T')[0];
        const endDate = lastDay.toISOString().split('T')[0];
        
        const allAttendanceSnap = await getDocs(collection(db, 'student_attendance'));
        const monthlyPresence = {};
        
        allAttendanceSnap.forEach(doc => {
            const data = doc.data();
            if (data.date >= startDate && data.date <= endDate && 
                data.studentId === studentId && data.published === true) {
                monthlyPresence[data.date] = data.status;
            }
        });
        
        let presentCount = 0;
        let absentCount = 0;
        let lateCount = 0;
        let totalDays = 0;
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            const status = monthlyPresence[dateStr];
            
            if (status) {
                totalDays++;
                if (status === 'present') presentCount++;
                else if (status === 'absent') absentCount++;
                else if (status === 'late') lateCount++;
            }
        }
        
        const statsContainer = document.getElementById('presence-stats');
        const presenceRate = totalDays > 0 ? ((presentCount / totalDays) * 100).toFixed(1) : 0;
        
        statsContainer.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" style="color: #2e7d32;">${presentCount}</div>
                    <div class="stat-label">Présences</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #c62828;">${absentCount}</div>
                    <div class="stat-label">Absences</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #ef6c00;">${lateCount}</div>
                    <div class="stat-label">Retards</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #1565c0;">${presenceRate}%</div>
                    <div class="stat-label">Taux de présence</div>
                </div>
            </div>
        `;
        
        let calendarHTML = `
            <h4 style="margin-bottom: 1rem;">Calendrier des présences - ${getMonthName(month)} ${year}</h4>
            <div class="attendance-grid">
        `;
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            const status = monthlyPresence[dateStr];
            
            let statusClass = 'attendance-empty';
            let statusText = day.toString();
            let title = `${day} ${getMonthName(month)} ${year}`;
            
            if (status === 'present') {
                statusClass = 'attendance-present';
                statusText = '✓';
                title += ' - Présent';
            } else if (status === 'absent') {
                statusClass = 'attendance-absent';
                statusText = '✗';
                title += ' - Absent';
            } else if (status === 'late') {
                statusClass = 'attendance-late';
                statusText = '⌚';
                title += ' - Retard';
            } else {
                title += ' - Non renseigné';
            }
            
            calendarHTML += `
                <div class="attendance-day ${statusClass}" title="${title}">
                    ${statusText}
                </div>
            `;
        }
        
        calendarHTML += '</div>';
        
        calendarHTML += `
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="attendance-day attendance-present" style="width: 20px; height: 20px; padding: 0;">✓</div>
                    <span>Présent</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="attendance-day attendance-absent" style="width: 20px; height: 20px; padding: 0;">✗</div>
                    <span>Absent</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="attendance-day attendance-late" style="width: 20px; height: 20px; padding: 0;">⌚</div>
                    <span>Retard</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="attendance-day attendance-empty" style="width: 20px; height: 20px; padding: 0; font-size: 0.7rem;">1</div>
                    <span>Non renseigné</span>
                </div>
            </div>
        `;
        
        container.innerHTML = calendarHTML;
        
    } catch (error) {
        console.error('Erreur chargement présences mensuelles:', error);
        container.innerHTML = '<div class="no-data"><i class="fas fa-exclamation-triangle"></i><p>Erreur de chargement des présences.</p></div>';
    }
}

async function loadChildIncidents(studentId) {
    const container = document.getElementById('incidents-list-container');
    container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Chargement des incidents...</p></div>';
    
    try {
        const incidentsQuery = query(
            collection(db, 'incidents'),
            orderBy('createdAt', 'desc')
        );
        
        const incidentsSnap = await getDocs(incidentsQuery);
        
        if (incidentsSnap.empty) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-check-circle"></i>
                    <p>Aucun incident signalé pour cet enfant.</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        let incidentsFound = false;
        
        incidentsSnap.forEach(doc => {
            const incident = { id: doc.id, ...doc.data() };
            
            const isChildIncident = 
                incident.studentMatricule === studentId || 
                incident.studentId === studentId ||
                incident.matricule === studentId ||
                (incident.student && incident.student.matricule === studentId);
            
            if (isChildIncident) {
                incidentsFound = true;
                const date = incident.createdAt ? new Date(incident.createdAt.toDate()).toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Date inconnue';
                
                const severityClass = `severity-${incident.severity}`;
                
                html += `
                    <div class="incident-item ${severityClass}">
                        <div class="incident-header">
                            <span class="incident-type">${getIncidentTypeLabel(incident.type)}</span>
                            <span class="incident-date">${date}</span>
                        </div>
                        <div class="incident-description">
                            ${incident.description || 'Aucune description fournie.'}
                        </div>
                        <div>
                            <span class="incident-severity ${severityClass}">
                                ${getSeverityLabel(incident.severity)}
                            </span>
                        </div>
                    </div>
                `;
            }
        });
        
        if (!incidentsFound) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-check-circle"></i>
                    <p>Aucun incident signalé pour cet enfant.</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = html;
        
        markNotificationsAsRead('presence-incidents');
        
    } catch (error) {
        console.error('Erreur chargement incidents:', error);
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Erreur de chargement des incidents: ${error.message}</p>
                <p style="font-size: 0.8rem; margin-top: 0.5rem;">
                    Si le problème persiste, veuillez contacter l'administration.
                </p>
            </div>
        `;
    }
}

// ============================================
// FONCTIONS POUR LES PAIEMENTS
// ============================================
document.getElementById('payment-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const paymentContent = document.getElementById('payment-content');
    if (!studentId) {
        paymentContent.classList.add('hidden');
        return;
    }
    paymentContent.classList.remove('hidden');
    loadPaymentStatus(studentId);
    setupPaymentForm(studentId);
});

async function loadPaymentStatus(studentId) {
    const statusContainer = document.getElementById('payment-status-container');
    statusContainer.innerHTML = "Chargement...";

    const paymentsQuery = query(collection(db, 'payments'), where('studentId', '==', studentId));
    const paymentsSnap = await getDocs(paymentsQuery);
    const paidMonths = paymentsSnap.docs.map(d => d.data().month);

    statusContainer.innerHTML = paidMonths.length > 0 
        ? `<p>Mois payés : <strong>${paidMonths.join(', ')}</strong></p>` 
        : "<p>Aucun paiement enregistré.</p>";
}

function setupPaymentForm(studentId) {
    const student = childrenList.find(c => c.matricule === studentId);
    if (student) {
        document.getElementById('payment-student-id').value = student.matricule;
        document.getElementById('payment-student-name').value = student.fullName;
        document.getElementById('payment-student-class').value = student.class;
    }
}

document.getElementById('online-payment-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const studentId = document.getElementById('payment-student-id').value;
    const studentName = document.getElementById('payment-student-name').value;
    const month = document.getElementById('payment-month').value;
    const amount = parseInt(document.getElementById('payment-amount').value);
    
    if (!studentId || !studentName || !month || !amount) {
        showAlert("Veuillez remplir tous les champs", "error");
        return;
    }
    
    try {
        const paymentCode = generatePaymentCode();
        
        await addDoc(collection(db, 'payment_requests'), {
            studentId: studentId,
            studentName: studentName,
            parentId: currentParent.matricule,
            months: [month],
            amount: amount,
            paymentCode: paymentCode,
            status: 'pending',
            createdAt: serverTimestamp()
        });

        document.getElementById('generated-code').textContent = paymentCode;
        
        const receiptPreview = document.getElementById('receipt-preview');
        receiptPreview.innerHTML = `
            <div class="receipt">
                <div class="receipt-header">
                    <div class="receipt-logo">
                        <h2>CS LA COLOMBE</h2>
                    </div>
                    <div class="receipt-title">DEMANDE DE PAIEMENT</div>
                    <div>Complexe Scolaire la Colombe</div>
                    <div>Code: ${paymentCode}</div>
                </div>
                
                <div class="receipt-details">
                    <div class="receipt-row">
                        <span>Élève:</span>
                        <span>${studentName}</span>
                    </div>
                    <div class="receipt-row">
                        <span>Mois:</span>
                        <span>${month}</span>
                    </div>
                    <div class="receipt-row">
                        <span>Montant:</span>
                        <span>${amount.toLocaleString()} FCFA</span>
                    </div>
                    <div class="receipt-divider"></div>
                    <div class="receipt-row">
                        <span>Date:</span>
                        <span>${new Date().toLocaleDateString('fr-FR')}</span>
                    </div>
                    <div class="receipt-row">
                        <span>Parent:</span>
                        <span>${currentParent.fullName}</span>
                    </div>
                </div>
                
                <div class="receipt-footer">
                    <p>Présentez ce document au secrétariat pour finaliser le paiement</p>
                    <p>Complexe Scolaire la Colombe</p>
                </div>
            </div>
        `;
        
        document.getElementById('payment-code-modal').classList.remove('hidden');
        document.getElementById('online-payment-form').reset();
        
    } catch (error) {
        showAlert('Erreur lors de la demande de paiement: ' + error.message, 'error');
    }
});

document.getElementById('download-receipt-btn').addEventListener('click', () => {
    const receiptContent = document.getElementById('receipt-preview').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Demande de Paiement</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .receipt { max-width: 500px; margin: 0 auto; border: 1px solid #ddd; padding: 1.5rem; }
                    .receipt-header { text-align: center; margin-bottom: 1.5rem; }
                    .receipt-title { font-size: 1.2rem; font-weight: bold; margin: 10px 0; }
                    .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
                    .receipt-divider { border-top: 1px solid #ddd; margin: 15px 0; }
                    .receipt-footer { text-align: center; margin-top: 1.5rem; font-size: 0.8rem; color: #666; }
                    @media print {
                        body { margin: 0; }
                        .receipt { border: none; box-shadow: none; }
                    }
                </style>
            </head>
            <body>
                ${receiptContent}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
});

// ============================================
// FONCTIONS POUR LES DEVOIRS
// ============================================
document.getElementById('secondary-homework-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const homeworkContent = document.getElementById('secondary-homework-content');
    if (!studentId) {
        homeworkContent.classList.add('hidden');
        return;
    }
    homeworkContent.classList.remove('hidden');
    loadSecondaryHomework(studentId);
});

document.getElementById('primary-homework-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const homeworkContent = document.getElementById('primary-homework-content');
    if (!studentId) {
        homeworkContent.classList.add('hidden');
        return;
    }
    homeworkContent.classList.remove('hidden');
    loadPrimaryHomework(studentId);
});

document.getElementById('kindergarten-homework-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const homeworkContent = document.getElementById('kindergarten-homework-content');
    if (!studentId) {
        homeworkContent.classList.add('hidden');
        return;
    }
    homeworkContent.classList.remove('hidden');
    loadKindergartenHomework(studentId);
});

function setupHomeworkTabs() {
    document.querySelectorAll('#secondary-homework-content .tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('#secondary-homework-content .tab, #secondary-homework-content .tab-content').forEach(el => el.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
            
            const studentId = document.getElementById('secondary-homework-child-selector').value;
            if (studentId) {
                if (tab.dataset.tab === 'pending') {
                    loadPendingHomework(studentId);
                } else if (tab.dataset.tab === 'submitted') {
                    loadSubmittedHomework(studentId);
                }
            }
        });
    });
}

async function loadSecondaryHomework(studentId) {
    await loadPendingHomework(studentId);
}

async function loadPendingHomework(studentId) {
    showLoading('pending-homework-loading');
    const container = document.getElementById('pending-homework-container');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'secondary') {
            container.innerHTML = '<p>Enfant non trouvé ou non du secondaire</p>';
            hideLoading('pending-homework-loading');
            return;
        }
        
        const homeworkQuery = query(
            collection(db, 'homework'), 
            where('className', '==', child.class),
            orderBy('dueDate', 'asc')
        );
        const homeworkSnap = await getDocs(homeworkQuery);

        if (homeworkSnap.empty) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-book-open"></i>
                    <h3>Aucun devoir en cours</h3>
                    <p>Votre enfant n'a aucun devoir à faire pour le moment.</p>
                </div>
            `;
            hideLoading('pending-homework-loading');
            return;
        }
        
        let html = '';
        const now = new Date();
        let hasPendingHomework = false;
        
        homeworkSnap.forEach(doc => {
            const hw = doc.data();
            
            const dueDate = hw.dueDate ? new Date(hw.dueDate.toDate()) : null;
            const dueDateStr = dueDate ? dueDate.toLocaleDateString('fr-FR') : 'Non spécifiée';
            
            const isOverdue = dueDate && dueDate < now;
            const isDueSoon = dueDate && (dueDate - now) < (2 * 24 * 60 * 60 * 1000);
            
            const hasSubmitted = hw.submissions && hw.submissions.some(
                submission => submission.studentMatricule === studentId
            );

            if (hasSubmitted) {
                return;
            }

            hasPendingHomework = true;
            
            let itemClass = 'homework-item';
            if (isOverdue) itemClass += ' overdue';
            else if (isDueSoon) itemClass += ' due-soon';
            
            const fileLink = hw.fileURL ? 
                `<a href="${hw.fileURL}" target="_blank" class="btn btn-primary btn-sm">
                    <i class="fas fa-download"></i> Télécharger ${hw.fileName || 'le fichier'}
                 </a>` : 
                '<p><em>Aucun fichier joint</em></p>';
            
            html += `
                <div class="${itemClass}">
                    <div class="homework-header">
                        <div>
                            <div class="homework-title">${hw.title || 'Devoir sans titre'}</div>
                            <div class="homework-meta">
                                <strong>Matière:</strong> ${hw.subject || 'Non spécifié'} | 
                                <strong>Enseignant:</strong> ${hw.teacherName || 'Non spécifié'} | 
                                <strong>Date de rendu:</strong> ${dueDateStr}
                            </div>
                        </div>
                        <div>
                            ${isOverdue ? 
                                '<span class="submission-status submission-overdue">En retard</span>' : 
                                '<span class="submission-status submission-pending">À rendre</span>'
                            }
                        </div>
                    </div>
                    <div class="homework-description">${hw.description || 'Aucune description'}</div>
                    ${fileLink}
                </div>
            `;
        });
        
        if (!hasPendingHomework) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-book-open"></i>
                    <h3>Aucun devoir en cours</h3>
                    <p>Votre enfant n'a aucun devoir à faire pour le moment.</p>
                </div>
            `;
        } else {
            container.innerHTML = html;
        }
        
        hideLoading('pending-homework-loading');
        
        markNotificationsAsRead('homework');
        
    } catch (error) {
        console.error('Erreur chargement devoirs en cours:', error);
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger les devoirs. Veuillez réessayer plus tard.</p>
            </div>
        `;
        hideLoading('pending-homework-loading');
    }
}

async function loadSubmittedHomework(studentId) {
    showLoading('submitted-homework-loading');
    const container = document.getElementById('submitted-homework-container');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'secondary') {
            container.innerHTML = '<p>Enfant non trouvé ou non du secondaire</p>';
            hideLoading('submitted-homework-loading');
            return;
        }
        
        const homeworkQuery = query(
            collection(db, 'homework'), 
            where('className', '==', child.class),
            orderBy('dueDate', 'desc')
        );
        const homeworkSnap = await getDocs(homeworkQuery);

        if (homeworkSnap.empty) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-book-open"></i>
                    <h3>Aucun devoir rendu</h3>
                    <p>Votre enfant n'a rendu aucun devoir pour le moment.</p>
                </div>
            `;
            hideLoading('submitted-homework-loading');
            return;
        }
        
        let html = '';
        let hasSubmittedHomework = false;
        
        homeworkSnap.forEach(doc => {
            const hw = doc.data();
            
            const studentSubmission = hw.submissions && hw.submissions.find(
                submission => submission.studentMatricule === studentId
            );
            
            if (!studentSubmission) return;
            
            hasSubmittedHomework = true;
            
            const dueDate = hw.dueDate ? new Date(hw.dueDate.toDate()) : null;
            const dueDateStr = dueDate ? dueDate.toLocaleDateString('fr-FR') : 'Non spécifiée';
            const submissionDate = studentSubmission.submittedAt ? 
                new Date(studentSubmission.submittedAt.toDate()).toLocaleDateString('fr-FR') : 'Non spécifiée';
            
            const isGraded = studentSubmission.grade !== undefined;
            const gradeText = isGraded ? 
                `${studentSubmission.grade}/${studentSubmission.maxPoints || 20}` : 
                'Non noté';
            
            const fileLink = hw.fileURL ? 
                `<a href="${hw.fileURL}" target="_blank" class="btn btn-primary btn-sm">
                    <i class="fas fa-download"></i> Télécharger le devoir
                 </a>` : 
                '<p><em>Aucun fichier joint</em></p>';
            
            const submissionFileLink = studentSubmission.fileURL ? 
                `<a href="${studentSubmission.fileURL}" target="_blank" class="btn btn-info btn-sm">
                    <i class="fas fa-download"></i> Soumission de l'élève
                 </a>` : 
                '<p><em>Soumission sans fichier</em></p>';
            
            html += `
                <div class="homework-item">
                    <div class="homework-header">
                        <div>
                            <div class="homework-title">${hw.title || 'Devoir sans titre'}</div>
                            <div class="homework-meta">
                                <strong>Matière:</strong> ${hw.subject || 'Non spécifié'} | 
                                <strong>Enseignant:</strong> ${hw.teacherName || 'Non spécifié'} | 
                                <strong>Date de rendu:</strong> ${dueDateStr} |
                                <strong>Rendu le:</strong> ${submissionDate}
                            </div>
                        </div>
                        <div>
                            ${isGraded ? 
                                `<span class="submission-status submission-graded">Noté: ${gradeText}</span>` : 
                                '<span class="submission-status submission-submitted">Rendu</span>'
                            }
                        </div>
                    </div>
                    <div class="homework-description">${hw.description || 'Aucune description'}</div>
                    ${fileLink}
                    <div style="margin-top: 1rem;">
                        <h5>Soumission de l'élève:</h5>
                        ${studentSubmission.textAnswer ? 
                            `<p><strong>Réponse textuelle:</strong> ${studentSubmission.textAnswer}</p>` : 
                            ''
                        }
                        ${submissionFileLink}
                        ${studentSubmission.comments ? 
                            `<p><strong>Commentaires de l'enseignant:</strong> ${studentSubmission.comments}</p>` : 
                            ''
                        }
                    </div>
                </div>
            `;
        });
        
        if (!hasSubmittedHomework) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-book-open"></i>
                    <h3>Aucun devoir rendu</h3>
                    <p>Votre enfant n'a rendu aucun devoir pour le moment.</p>
                </div>
            `;
        } else {
            container.innerHTML = html;
        }
        
        hideLoading('submitted-homework-loading');
        
    } catch (error) {
        console.error('Erreur chargement devoirs rendus:', error);
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger les devoirs rendus. Veuillez réessayer plus tard.</p>
            </div>
        `;
        hideLoading('submitted-homework-loading');
    }
}

async function loadPrimaryHomework(studentId) {
    showLoading('primary-homework-loading');
    const container = document.getElementById('primary-homework-container');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'primary') {
            container.innerHTML = '<p>Enfant non trouvé ou non du primaire</p>';
            hideLoading('primary-homework-loading');
            return;
        }
        
        const homeworkQuery = query(
            collection(db, 'homework'),
            where('className', '==', child.class),
            where('published', '==', true),
            orderBy('createdAt', 'desc')
        );
        
        const homeworkSnap = await getDocs(homeworkQuery);

        if (homeworkSnap.empty) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-book"></i>
                    <h3>Aucun devoir publié</h3>
                    <p>Aucun devoir n'a été publié pour la classe de votre enfant.</p>
                </div>
            `;
            hideLoading('primary-homework-loading');
            return;
        }
        
        let html = '';
        
        homeworkSnap.forEach(doc => {
            const hw = doc.data();
            const dueDate = hw.dueDate ? new Date(hw.dueDate.toDate()).toLocaleDateString('fr-FR') : 'Non spécifiée';
            const createdAt = hw.createdAt ? new Date(hw.createdAt.toDate()).toLocaleDateString('fr-FR') : 'Non spécifiée';
            
            const fileLink = hw.fileURL ? 
                `<a href="${hw.fileURL}" target="_blank" class="btn btn-primary btn-sm">
                    <i class="fas fa-download"></i> Télécharger ${hw.fileName || 'le fichier'}
                 </a>` : 
                '<p><em>Aucun fichier joint</em></p>';
            
            html += `
                <div class="primary-homework-item">
                    <div class="homework-header">
                        <div>
                            <div class="homework-title">${hw.title || 'Devoir sans titre'}</div>
                            <div class="homework-meta">
                                <strong>Matière:</strong> ${hw.subject || 'Non spécifié'} | 
                                <strong>Enseignant:</strong> ${hw.teacherName || 'Non spécifié'} | 
                                <strong>Date de rendu:</strong> ${dueDate}
                            </div>
                        </div>
                    </div>
                    <div class="homework-description">${hw.description || 'Aucune description'}</div>
                    ${fileLink}
                    <div class="homework-meta" style="margin-top: 1rem;">
                        <small>Publié le: ${createdAt}</small>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        hideLoading('primary-homework-loading');
        
    } catch (error) {
        console.error('Erreur chargement devoirs primaire:', error);
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger les devoirs. Veuillez réessayer plus tard.</p>
            </div>
        `;
        hideLoading('primary-homework-loading');
    }
}

async function loadKindergartenHomework(studentId) {
    showLoading('kindergarten-homework-loading');
    const container = document.getElementById('kindergarten-homework-container');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'kindergarten') {
            container.innerHTML = '<p>Enfant non trouvé ou non de la maternelle</p>';
            hideLoading('kindergarten-homework-loading');
            return;
        }
        
        const homeworkQuery = query(
            collection(db, 'kindergarten_homework'),
            where('className', '==', child.class),
            where('published', '==', true),
            orderBy('createdAt', 'desc')
        );
        
        const homeworkSnap = await getDocs(homeworkQuery);

        if (homeworkSnap.empty) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-baby"></i>
                    <h3>Aucune activité publiée</h3>
                    <p>Aucune activité n'a été publiée pour la classe de votre enfant.</p>
                </div>
            `;
            hideLoading('kindergarten-homework-loading');
            return;
        }
        
        let html = '';
        
        homeworkSnap.forEach(doc => {
            const homework = doc.data();
            const dueDate = homework.dueDate?.toDate ? 
                homework.dueDate.toDate().toLocaleDateString('fr-FR') : 
                new Date(homework.dueDate).toLocaleDateString('fr-FR');
            
            const createdAt = homework.createdAt?.toDate ? 
                homework.createdAt.toDate().toLocaleDateString('fr-FR') : 
                'Date inconnue';
            
            const now = new Date();
            const dueDateObj = new Date(dueDate);
            const isOverdue = dueDateObj < now;
            const isDueSoon = (dueDateObj - now) < (2 * 24 * 60 * 60 * 1000) && !isOverdue;
            
            let statusBadge = '';
            if (isOverdue) {
                statusBadge = '<span class="badge badge-danger">En retard</span>';
            } else if (isDueSoon) {
                statusBadge = '<span class="badge badge-warning">À rendre bientôt</span>';
            } else {
                statusBadge = '<span class="badge badge-success">À venir</span>';
            }
            
            let fileSection = '';
            if (homework.fileInfo && homework.fileInfo.url) {
                const fileIcon = getFileIconForParent(homework.fileInfo.type);
                const fileSize = homework.fileInfo.size ? 
                    `(${(homework.fileInfo.size / 1024).toFixed(2)} KB)` : '';
                
                fileSection = `
                    <div class="file-preview" style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--info);">
                        <div class="file-info">
                            <i class="fas ${fileIcon}" style="font-size: 2rem; color: var(--info);"></i>
                            <div class="file-details">
                                <h5 style="margin: 0;">Fichier joint</h5>
                                <p style="margin: 0.25rem 0; color: #666;">${homework.fileInfo.name}</p>
                                <small style="color: #999;">Type: ${homework.fileInfo.type} ${fileSize}</small>
                            </div>
                        </div>
                        
                        <div class="file-actions" style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-sm" onclick="window.open('${homework.fileInfo.url}', '_blank')">
                                <i class="fas fa-external-link-alt"></i> Ouvrir
                            </button>
                            <button class="btn btn-success btn-sm" onclick="window.downloadHomeworkFile('${homework.fileInfo.url}', '${homework.fileInfo.name}')">
                                <i class="fas fa-download"></i> Télécharger
                            </button>
                        </div>
                    </div>
                `;
            }
            
            html += `
                <div class="primary-homework-item ${isOverdue ? 'overdue' : isDueSoon ? 'due-soon' : ''}">
                    <div class="homework-header">
                        <div>
                            <div class="homework-title">${homework.title}</div>
                            <div class="homework-meta">
                                <strong>Activité:</strong> ${homework.subject || 'Non spécifié'} | 
                                <strong>Enseignant:</strong> ${homework.teacherName || 'Non spécifié'} | 
                                <strong>Date de rendu:</strong> ${dueDate}
                                ${statusBadge}
                            </div>
                        </div>
                    </div>
                    <div class="homework-description">
                        ${homework.description || 'Aucune description'}
                    </div>
                    ${fileSection}
                    <div class="homework-meta" style="margin-top: 1rem;">
                        <small style="color: #666;">Publié le: ${createdAt}</small>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        hideLoading('kindergarten-homework-loading');
        
        markNotificationsAsRead('homework');
        
    } catch (error) {
        console.error('Erreur chargement devoirs maternelle:', error);
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger les activités. Veuillez réessayer plus tard.</p>
                <p><small>Erreur technique: ${error.message}</small></p>
            </div>
        `;
        hideLoading('kindergarten-homework-loading');
    }
}

function getFileIconForParent(fileType) {
    if (fileType.includes('pdf')) return 'fa-file-pdf text-danger';
    if (fileType.includes('word') || fileType.includes('document')) return 'fa-file-word text-primary';
    if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fa-file-excel text-success';
    if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'fa-file-powerpoint text-warning';
    if (fileType.includes('image')) return 'fa-file-image text-info';
    if (fileType.includes('video')) return 'fa-file-video text-danger';
    if (fileType.includes('audio')) return 'fa-file-audio text-secondary';
    if (fileType.includes('zip') || fileType.includes('compressed')) return 'fa-file-archive text-warning';
    return 'fa-file text-muted';
}

window.downloadHomeworkFile = function(url, fileName) {
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName || 'devoir';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showToast(`Téléchargement de ${fileName}`, 'success');
};

window.markHomeworkAsRead = async function(homeworkId) {
    try {
        const notificationsQuery = query(
            collection(db, 'parent_notifications'),
            where('parentId', '==', currentParent.matricule),
            where('data.type', '==', 'homework')
        );
        
        const notificationsSnap = await getDocs(notificationsQuery);
        
        for (const notificationDoc of notificationsSnap.docs) {
            const notificationData = notificationDoc.data();
            if (notificationData.data?.homeworkId === homeworkId) {
                await updateDoc(doc(db, 'parent_notifications', notificationDoc.id), {
                    read: true,
                    readAt: serverTimestamp()
                });
                break;
            }
        }
        
        showToast('Activité marquée comme vue', 'success');
        
    } catch (error) {
        console.error('Erreur marquage devoir:', error);
    }
};

// ============================================
// FONCTIONS POUR LE TABLEAU DE BORD
// ============================================
document.getElementById('child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const dashboardContent = document.getElementById('child-dashboard-content');
    if (!studentId) {
        dashboardContent.classList.add('hidden');
        return;
    }
    dashboardContent.classList.remove('hidden');
    loadChildDashboard(studentId);
});

async function loadChildDashboard(studentId) {
    const child = childrenList.find(c => c.matricule === studentId);
    if (!child) return;
    
    if (child.type === 'secondary') {
        await loadChildProclamationData(studentId, 'P1');
    } else if (child.type === 'primary') {
        await loadPrimaryGradesForDashboard(studentId, '1ère période');
    } else {
        await loadKindergartenGradesForDashboard(studentId);
    }
    
    const attendanceContainer = document.getElementById('attendance-container');
    attendanceContainer.innerHTML = "Chargement...";
    
    const attQuery = query(collection(db, 'student_attendance'), where('studentId', '==', studentId));
    const attSnap = await getDocs(attQuery);
    
    let presentCount = 0;
    let totalCount = 0;
    
    attSnap.forEach(doc => {
        const attendanceData = doc.data();
        if (attendanceData.published === true) {
            totalCount++;
            if (attendanceData.status === 'present') {
                presentCount++;
            }
        }
    });
    
    const attendanceRate = totalCount > 0 ? (presentCount / totalCount * 100).toFixed(0) : 0;
    attendanceContainer.innerHTML = `
        <p>Taux de présence: <strong>${attendanceRate}%</strong></p>
        <p>Présences: ${presentCount} / ${totalCount}</p>
    `;
    
    const homeworkContainer = document.getElementById('homework-container');
    homeworkContainer.innerHTML = "Chargement...";
    
    if (child.type === 'secondary') {
        const hwQuery = query(collection(db, 'homework'), where('className', '==', child.class), orderBy('dueDate', 'desc'), limit(5));
        const hwSnap = await getDocs(hwQuery);
        
        if (hwSnap.empty) {
            homeworkContainer.innerHTML = "<p>Aucun devoir récent.</p>";
        } else {
            let html = '<ul>';
            hwSnap.forEach(doc => {
                const hw = doc.data();
                const dueDate = hw.dueDate ? new Date(hw.dueDate.toDate()).toLocaleDateString('fr-FR') : 'Non spécifiée';
                html += `<li><strong>${hw.subject}:</strong> ${hw.title} (à rendre le ${dueDate})</li>`;
            });
            html += '</ul>';
            homeworkContainer.innerHTML = html;
        }
    } else if (child.type === 'primary') {
        const hwQuery = query(collection(db, 'homework'), where('className', '==', child.class), orderBy('createdAt', 'desc'), limit(5));
        const hwSnap = await getDocs(hwQuery);
        
        if (hwSnap.empty) {
            homeworkContainer.innerHTML = "<p>Aucun devoir récent.</p>";
        } else {
            let html = '<ul>';
            hwSnap.forEach(doc => {
                const hw = doc.data();
                const dueDate = hw.dueDate ? new Date(hw.dueDate.toDate()).toLocaleDateString('fr-FR') : 'Non spécifiée';
                html += `<li><strong>${hw.subject}:</strong> ${hw.title} (pour le ${dueDate})</li>`;
            });
            html += '</ul>';
            homeworkContainer.innerHTML = html;
        }
    } else {
        homeworkContainer.innerHTML = "<p>Les devoirs de la maternelle ne sont pas encore disponibles.</p>";
    }
}

async function loadPrimaryGradesForDashboard(studentId, period) {
    const tableBody = document.getElementById('child-grades-table-body');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'primary') {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Enfant non du primaire</td></tr>';
            return;
        }
        
        const gradesQuery = query(
            collection(db, 'primary_published_grades'),
            where('studentId', '==', studentId),
            where('period', '==', period)
        );
        
        const gradesSnap = await getDocs(gradesQuery);
        
        if (gradesSnap.empty) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune cote disponible.</td></tr>';
            return;
        }
        
        let allGrades = [];
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            gradeData.grades.forEach(courseGrade => {
                allGrades.push({
                    courseName: courseGrade.courseName,
                    maxGrade: courseGrade.maxGrade,
                    obtainedGrade: courseGrade.obtainedGrade,
                    teacherName: courseGrade.teacherName
                });
            });
        });
        
        if (allGrades.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune cote trouvée.</td></tr>';
            return;
        }
        
        allGrades = allGrades.slice(0, 10);
        
        let html = '';
        allGrades.forEach((grade, index) => {
            const percentage = (grade.obtainedGrade / grade.maxGrade) * 100;
            const gradeClass = percentage >= 50 ? 'grade-green' : 'grade-red';
            
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${grade.courseName}</td>
                    <td>${grade.maxGrade}</td>
                    <td class="${gradeClass}">${grade.obtainedGrade}</td>
                    <td>${grade.teacherName}</td>
                    <td>Primaire</td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
        
    } catch (error) {
        console.error('Erreur chargement cotes tableau de bord:', error);
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Erreur de chargement.</td></tr>';
    }
}

async function loadKindergartenGradesForDashboard(studentId) {
    const tableBody = document.getElementById('child-grades-table-body');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'kindergarten') {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Enfant non de la maternelle</td></tr>';
            return;
        }
        
        const gradesQuery = query(
            collection(db, 'kindergarten_grades'),
            where('studentId', '==', studentId),
            orderBy('evaluationDate', 'desc'),
            limit(10)
        );
        
        const gradesSnap = await getDocs(gradesQuery);
        
        if (gradesSnap.empty) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune cote disponible.</td></tr>';
            return;
        }
        
        let html = '';
        let index = 1;
        
        const levels = {
            'excellent': 'Excellent',
            'tres_bien': 'Très bien',
            'bien': 'Bien',
            'suffisant': 'Suffisant',
            'insuffisant': 'Insuffisant'
        };
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            const evaluationDate = gradeData.evaluationDate ? 
                new Date(gradeData.evaluationDate.toDate()).toLocaleDateString('fr-FR') : 'Non spécifiée';
            
            const levelText = levels[gradeData.level] || gradeData.level;
            const levelClass = gradeData.level === 'excellent' || gradeData.level === 'tres_bien' ? 'grade-green' : 
                             gradeData.level === 'insuffisant' ? 'grade-red' : '';
            
            html += `
                <tr>
                    <td>${index}</td>
                    <td>${gradeData.competence || 'Compétence'}</td>
                    <td class="${levelClass}">${levelText}</td>
                    <td>${gradeData.appreciation || ''}</td>
                    <td>${gradeData.teacherName || ''}</td>
                    <td>${evaluationDate}</td>
                </tr>
            `;
            index++;
        });
        
        tableBody.innerHTML = html;
        
    } catch (error) {
        console.error('Erreur chargement cotes maternelle tableau de bord:', error);
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Erreur de chargement.</td></tr>';
    }
}

// ============================================
// FONCTIONS POUR LES COTES SECONDAIRES
// ============================================
function setupSecondaryGradesPeriods() {
    document.querySelectorAll('#secondary-grades-content .period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#secondary-grades-content .period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            currentGradesPeriod = this.getAttribute('data-period');
            
            const studentId = document.getElementById('secondary-grades-child-selector').value;
            if (studentId) {
                loadChildProclamationData(studentId, currentGradesPeriod);
            }
        });
    });
}

document.getElementById('secondary-grades-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const gradesContent = document.getElementById('secondary-grades-content');
    if (!studentId) {
        gradesContent.classList.add('hidden');
        return;
    }
    gradesContent.classList.remove('hidden');
    loadChildProclamationData(studentId, 'P1');
});

async function loadChildProclamationData(studentId, period) {
    showLoading('secondary-grades-loading');
    const tableContainer = document.getElementById('grades-table-container');
    const noGradesMessage = document.getElementById('no-grades-message');
    const periodInfoCard = document.getElementById('period-info-card');
    const selectedPeriodName = document.getElementById('selected-period-name');
    const periodCalculationInfo = document.getElementById('period-calculation-info');
    
    tableContainer.classList.add('hidden');
    noGradesMessage.classList.add('hidden');
    periodInfoCard.classList.add('hidden');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'secondary') {
            throw new Error('Enfant non trouvé ou non du secondaire');
        }
        
        periodInfoCard.classList.remove('hidden');
        selectedPeriodName.textContent = getPeriodNameForParent(period);
        periodCalculationInfo.textContent = getPeriodCalculationInfoForParent(period);
        
        if (period === 'TOTAL_S1' || period === 'TOTAL_S2' || period === 'TOTAL_GENERAL') {
            document.getElementById('period-auto-calc-info').classList.remove('hidden');
            
            const calculatedData = await calculateAutomaticTotals(studentId, period);
            
            if (!calculatedData || Object.keys(calculatedData.coursesData).length === 0) {
                hideLoading('secondary-grades-loading');
                noGradesMessage.classList.remove('hidden');
                return;
            }
            
            childGradesData = calculatedData;
            
            displayChildProclamationTableWithTotals(child, calculatedData, period);
            
            hideLoading('secondary-grades-loading');
            tableContainer.classList.remove('hidden');
            document.getElementById('child-name-header').textContent = child.fullName;
            
            return;
        }
        
        const gradesQuery = query(
            collection(db, 'parent_grades'),
            where('className', '==', child.class),
            where('period', '==', period)
        );
        
        const gradesSnap = await getDocs(gradesQuery);
        
        if (gradesSnap.empty) {
            hideLoading('secondary-grades-loading');
            noGradesMessage.classList.remove('hidden');
            return;
        }
        
        const coursesData = {};
        let childFound = false;
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            const courseName = gradeData.subject;
            
            const studentGrade = gradeData.grades.find(g => g.studentMatricule === studentId);
            
            if (studentGrade) {
                childFound = true;
                
                if (!coursesData[courseName]) {
                    coursesData[courseName] = {
                        teacherName: gradeData.teacherName,
                        maxPoints: gradeData.maxPoints,
                        evaluationDate: gradeData.evaluationDate,
                        grades: {}
                    };
                }
                
                const cm = gradeData.maxPoints;
                const co = studentGrade.grade;
                
                coursesData[courseName].grades[studentId] = {
                    studentName: studentGrade.studentName,
                    cm: cm,
                    co: co,
                    remark: studentGrade.remark || ''
                };
            }
        });
        
        if (!childFound) {
            hideLoading('secondary-grades-loading');
            noGradesMessage.classList.remove('hidden');
            return;
        }
        
        childGradesData = {
            childName: child.fullName,
            className: child.class,
            period: period,
            coursesData: coursesData
        };
        
        displayChildProclamationTable(child, coursesData, period);
        
        hideLoading('secondary-grades-loading');
        tableContainer.classList.remove('hidden');
        document.getElementById('child-name-header').textContent = child.fullName;
        
    } catch (error) {
        console.error('Erreur chargement proclamation enfant:', error);
        hideLoading('secondary-grades-loading');
        
        const container = document.getElementById('grades-proclamation-table-container');
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>${error.message}</p>
            </div>
        `;
        tableContainer.classList.remove('hidden');
    }
}

async function calculateAutomaticTotals(childId, period) {
    const child = childrenList.find(c => c.matricule === childId);
    if (!child || child.type !== 'secondary') return null;
    
    try {
        let totalData = {
            childName: child.fullName,
            className: child.class,
            period: period,
            coursesData: {},
            calculatedTotals: {
                totalCM: 0,
                totalCO: 0,
                average: 0
            }
        };
        
        if (period === 'TOTAL_S1') {
            await calculateSemesterTotal(childId, 'TOTAL_S1', ['P1', 'P2', 'EXAM_S1'], totalData);
        } 
        else if (period === 'TOTAL_S2') {
            await calculateSemesterTotal(childId, 'TOTAL_S2', ['P3', 'P4', 'EXAM_S2'], totalData);
        } 
        else if (period === 'TOTAL_GENERAL') {
            await calculateGeneralTotal(childId, totalData);
        }
        
        return totalData;
        
    } catch (error) {
        console.error('Erreur calcul automatique:', error);
        return null;
    }
}

async function calculateSemesterTotal(childId, targetPeriod, sourcePeriods, totalData) {
    const child = childrenList.find(c => c.matricule === childId);
    
    for (const sourcePeriod of sourcePeriods) {
        const gradesQuery = query(
            collection(db, 'parent_grades'),
            where('className', '==', child.class),
            where('period', '==', sourcePeriod)
        );
        
        const gradesSnap = await getDocs(gradesQuery);
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            const courseName = gradeData.subject;
            
            const studentGrade = gradeData.grades.find(g => g.studentMatricule === childId);
            
            if (studentGrade) {
                if (!totalData.coursesData[courseName]) {
                    totalData.coursesData[courseName] = {
                        teacherName: gradeData.teacherName,
                        maxPoints: gradeData.maxPoints,
                        periods: {},
                        totalCM: 0,
                        totalCO: 0
                    };
                }
                
                totalData.coursesData[courseName].periods[sourcePeriod] = {
                    cm: gradeData.maxPoints,
                    co: studentGrade.grade,
                    percentage: studentGrade.percentage || 0
                };
                
                totalData.coursesData[courseName].totalCM += gradeData.maxPoints;
                totalData.coursesData[courseName].totalCO += studentGrade.grade;
            }
        });
    }
    
    let generalTotalCM = 0;
    let generalTotalCO = 0;
    
    Object.values(totalData.coursesData).forEach(course => {
        generalTotalCM += course.totalCM;
        generalTotalCO += course.totalCO;
    });
    
    totalData.calculatedTotals = {
        totalCM: generalTotalCM,
        totalCO: generalTotalCO,
        average: generalTotalCM > 0 ? (generalTotalCO / generalTotalCM) : 0
    };
}

async function calculateGeneralTotal(childId, totalData) {
    const semester1Data = await calculateAutomaticTotals(childId, 'TOTAL_S1');
    const semester2Data = await calculateAutomaticTotals(childId, 'TOTAL_S2');
    
    if (!semester1Data || !semester2Data) return;
    
    const allCourses = new Set([
        ...Object.keys(semester1Data.coursesData || {}),
        ...Object.keys(semester2Data.coursesData || {})
    ]);
    
    allCourses.forEach(courseName => {
        const course1 = semester1Data.coursesData[courseName];
        const course2 = semester2Data.coursesData[courseName];
        
        totalData.coursesData[courseName] = {
            teacherName: course1?.teacherName || course2?.teacherName || 'Non spécifié',
            totalCM: ((course1?.totalCM || 0) + (course2?.totalCM || 0)) / 2,
            totalCO: ((course1?.totalCO || 0) + (course2?.totalCO || 0)) / 2,
            semester1: course1 ? {
                cm: course1.totalCM,
                co: course1.totalCO,
                average: course1.totalCM > 0 ? (course1.totalCO / course1.totalCM) : 0
            } : null,
            semester2: course2 ? {
                cm: course2.totalCM,
                co: course2.totalCO,
                average: course2.totalCM > 0 ? (course2.totalCO / course2.totalCM) : 0
            } : null
        };
        
        const course = totalData.coursesData[courseName];
        course.average = course.totalCM > 0 ? (course.totalCO / course.totalCM) : 0;
    });
    
    const semester1Total = semester1Data.calculatedTotals;
    const semester2Total = semester2Data.calculatedTotals;
    
    totalData.calculatedTotals = {
        semester1: semester1Total,
        semester2: semester2Total,
        totalCM: (semester1Total.totalCM + semester2Total.totalCM) / 2,
        totalCO: (semester1Total.totalCO + semester2Total.totalCO) / 2,
        average: ((semester1Total.average + semester2Total.average) / 2)
    };
}

function displayChildProclamationTable(child, coursesData, period) {
    const container = document.getElementById('grades-proclamation-table-container');
    const courseNames = Object.keys(coursesData);
    
    if (courseNames.length === 0) {
        container.innerHTML = '<p>Aucune donnée disponible pour cette période.</p>';
        return;
    }
    
    let totalCM = 0;
    let totalCO = 0;
    
    courseNames.forEach(courseName => {
        const course = coursesData[courseName];
        const childGrade = course.grades[child.matricule];
        
        if (childGrade) {
            totalCM += childGrade.cm;
            totalCO += childGrade.co;
        }
    });
    
    let html = `
        <div class="grades-summary">
            <div class="summary-card">
                <h5>Cours Évalués</h5>
                <div class="value">${courseNames.length}</div>
            </div>
            <div class="summary-card">
                <h5>Total CM</h5>
                <div class="value">${totalCM.toFixed(2)}</div>
            </div>
            <div class="summary-card">
                <h5>Total CO</h5>
                <div class="value">${totalCO.toFixed(2)}</div>
            </div>
            <div class="summary-card">
                <h5>Moyenne Générale</h5>
                <div class="value">${totalCM > 0 ? (totalCO / totalCM).toFixed(2) : '0.00'}</div>
                <div class="sub-value">Sans pourcentage</div>
            </div>
        </div>
        
        <table class="parent-proclamation-table">
            <thead>
                <tr>
                    <th rowspan="2">N°</th>
                    <th rowspan="2">Cours</th>
                    <th rowspan="2">Enseignant</th>
                    <th colspan="2">Cotes</th>
                    <th rowspan="2">Date</th>
                    <th rowspan="2">Remarques</th>
                </tr>
                <tr>
                    <th class="sub-header">CM</th>
                    <th class="sub-header">CO</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    courseNames.sort();
    
    courseNames.forEach((courseName, index) => {
        const course = coursesData[courseName];
        const childGrade = course.grades[child.matricule];
        
        if (!childGrade) return;
        
        const evaluationDate = course.evaluationDate ? 
            new Date(course.evaluationDate.toDate()).toLocaleDateString('fr-FR') : 
            'Non spécifiée';
        
        let gradeClass = 'grade-average';
        const ratio = childGrade.cm > 0 ? childGrade.co / childGrade.cm : 0;
        
        if (ratio >= 0.75) gradeClass = 'grade-good';
        else if (ratio >= 0.5) gradeClass = 'grade-average';
        else gradeClass = 'grade-poor';
        
        html += `
            <tr>
                <td>${index + 1}</td>
                <td><strong>${courseName}</strong></td>
                <td>${course.teacherName}</td>
                <td>${childGrade.cm.toFixed(2)}</td>
                <td class="${gradeClass}">${childGrade.co.toFixed(2)}</td>
                <td>${evaluationDate}</td>
                <td>${childGrade.remark || '-'}</td>
            </tr>
        `;
    });
    
    html += `
            <tr class="total-row">
                <td colspan="3"><strong>TOTAUX</strong></td>
                <td><strong>${totalCM.toFixed(2)}</strong></td>
                <td><strong>${totalCO.toFixed(2)}</strong></td>
                <td colspan="2">
                    <strong>Moyenne: ${totalCM > 0 ? (totalCO / totalCM).toFixed(2) : '0.00'}</strong>
                </td>
            </tr>
        </tbody>
    </table>
    `;
    
    container.innerHTML = html;
}

function displayChildProclamationTableWithTotals(child, calculatedData, period) {
    const container = document.getElementById('grades-proclamation-table-container');
    const courseNames = Object.keys(calculatedData.coursesData);
    
    if (courseNames.length === 0) {
        container.innerHTML = '<p>Aucune donnée disponible pour cette période.</p>';
        return;
    }
    
    let html = `
        <div class="grades-summary">
            <div class="summary-card">
                <h5>Cours Évalués</h5>
                <div class="value">${courseNames.length}</div>
            </div>
    `;
    
    if (period === 'TOTAL_S1') {
        html += `
            <div class="summary-card">
                <h5>Total Semestre 1</h5>
                <div class="value">${calculatedData.calculatedTotals.average.toFixed(2)}</div>
                <div class="sub-value">P1 + P2 + EXAM_S1</div>
            </div>
        `;
    } else if (period === 'TOTAL_S2') {
        html += `
            <div class="summary-card">
                <h5>Total Semestre 2</h5>
                <div class="value">${calculatedData.calculatedTotals.average.toFixed(2)}</div>
                <div class="sub-value">P3 + P4 + EXAM_S2</div>
            </div>
        `;
    } else if (period === 'TOTAL_GENERAL') {
        html += `
            <div class="summary-card">
                <h5>Total Général</h5>
                <div class="value">${calculatedData.calculatedTotals.average.toFixed(2)}</div>
                <div class="sub-value">Moyenne(TOTAL_S1, TOTAL_S2)</div>
            </div>
            <div class="summary-card">
                <h5>Semestre 1</h5>
                <div class="value">${calculatedData.calculatedTotals.semester1.average.toFixed(2)}</div>
            </div>
            <div class="summary-card">
                <h5>Semestre 2</h5>
                <div class="value">${calculatedData.calculatedTotals.semester2.average.toFixed(2)}</div>
            </div>
        `;
    }
    
    html += `
        </div>
        
        <table class="parent-proclamation-table">
            <thead>
                <tr>
                    <th rowspan="2">N°</th>
                    <th rowspan="2">Cours</th>
                    <th rowspan="2">Enseignant</th>
    `;
    
    if (period === 'TOTAL_GENERAL') {
        html += `
                    <th colspan="2">Semestre 1</th>
                    <th colspan="2">Semestre 2</th>
                    <th colspan="2">Total Général</th>
                </tr>
                <tr>
                    <th class="sub-header">CM</th>
                    <th class="sub-header">CO</th>
                    <th class="sub-header">CM</th>
                    <th class="sub-header">CO</th>
                    <th class="sub-header">CM</th>
                    <th class="sub-header">CO</th>
                </tr>
        `;
    } else if (period === 'TOTAL_S1' || period === 'TOTAL_S2') {
        html += `
                    <th colspan="3">Composition</th>
                    <th colspan="2">Total</th>
                </tr>
                <tr>
                    <th class="sub-header">Périodes</th>
                    <th class="sub-header">CM</th>
                    <th class="sub-header">CO</th>
                    <th class="sub-header">CM Total</th>
                    <th class="sub-header">CO Total</th>
                </tr>
        `;
    }
    
    html += `
            </thead>
            <tbody>
    `;
    
    courseNames.sort();
    
    courseNames.forEach((courseName, index) => {
        const course = calculatedData.coursesData[courseName];
        
        let gradeClass = 'grade-average';
        const average = course.average || (course.totalCM > 0 ? course.totalCO / course.totalCM : 0);
        
        if (average >= 0.75) gradeClass = 'grade-good';
        else if (average >= 0.5) gradeClass = 'grade-average';
        else gradeClass = 'grade-poor';
        
        if (period === 'TOTAL_GENERAL') {
            const s1 = course.semester1;
            const s2 = course.semester2;
            
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${courseName}</strong></td>
                    <td>${course.teacherName}</td>
                    <td>${s1 ? s1.cm.toFixed(2) : '0.00'}</td>
                    <td>${s1 ? s1.co.toFixed(2) : '0.00'}</td>
                    <td>${s2 ? s2.cm.toFixed(2) : '0.00'}</td>
                    <td>${s2 ? s2.co.toFixed(2) : '0.00'}</td>
                    <td>${course.totalCM.toFixed(2)}</td>
                    <td class="${gradeClass}">${course.totalCO.toFixed(2)}</td>
                </tr>
            `;
        } else if (period === 'TOTAL_S1' || period === 'TOTAL_S2') {
            const periods = course.periods ? Object.keys(course.periods) : [];
            const periodDetails = periods.map(p => 
                `${p}: ${course.periods[p].co.toFixed(2)}/${course.periods[p].cm.toFixed(2)}`
            ).join('<br>');
            
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${courseName}</strong></td>
                    <td>${course.teacherName}</td>
                    <td>${periodDetails || '-'}</td>
                    <td>${course.totalCM.toFixed(2)}</td>
                    <td class="${gradeClass}">${course.totalCO.toFixed(2)}</td>
                </tr>
            `;
        }
    });
    
    html += `
            <tr class="total-row">
                <td colspan="${period === 'TOTAL_GENERAL' ? 3 : 4}"><strong>TOTAUX FINAUX</strong></td>
    `;
    
    if (period === 'TOTAL_GENERAL') {
        html += `
                <td><strong>${calculatedData.calculatedTotals.semester1.totalCM.toFixed(2)}</strong></td>
                <td><strong>${calculatedData.calculatedTotals.semester1.totalCO.toFixed(2)}</strong></td>
                <td><strong>${calculatedData.calculatedTotals.semester2.totalCM.toFixed(2)}</strong></td>
                <td><strong>${calculatedData.calculatedTotals.semester2.totalCO.toFixed(2)}</strong></td>
                <td><strong>${calculatedData.calculatedTotals.totalCM.toFixed(2)}</strong></td>
                <td class="grade-${calculatedData.calculatedTotals.average >= 0.5 ? 'good' : 'poor'}">
                    <strong>${calculatedData.calculatedTotals.totalCO.toFixed(2)}</strong>
                </td>
        `;
    } else {
        html += `
                <td><strong>${calculatedData.calculatedTotals.totalCM.toFixed(2)}</strong></td>
                <td class="grade-${calculatedData.calculatedTotals.average >= 0.5 ? 'good' : 'poor'}">
                    <strong>${calculatedData.calculatedTotals.totalCO.toFixed(2)}</strong>
                </td>
        `;
    }
    
    html += `
            </tr>
            <tr class="total-row">
                <td colspan="${period === 'TOTAL_GENERAL' ? 9 : 6}" style="text-align: center;">
                    <strong>MOYENNE GÉNÉRALE: ${calculatedData.calculatedTotals.average.toFixed(2)}</strong>
                    <br><small>${getPeriodCalculationInfoForParent(period)}</small>
                </td>
            </tr>
        </tbody>
    </table>
    `;
    
    container.innerHTML = html;
}

// ============================================
// FONCTIONS POUR LES COTES PRIMAIRES
// ============================================
function setupPrimaryPeriods() {
    const periodButtons = document.querySelectorAll('#primary-grades-content .period-btn');
    periodButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            periodButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentPrimaryPeriod = this.dataset.period;
            
            const studentId = document.getElementById('primary-grades-child-selector').value;
            if (studentId) {
                loadPrimaryGrades(studentId, currentPrimaryPeriod);
            }
        });
    });
}

document.getElementById('primary-grades-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const gradesContent = document.getElementById('primary-grades-content');
    if (!studentId) {
        gradesContent.classList.add('hidden');
        return;
    }
    gradesContent.classList.remove('hidden');
    setupPrimaryPeriods();
    loadPrimaryGrades(studentId, currentPrimaryPeriod);
});

async function loadPrimaryGrades(studentId, period) {
    showLoading('primary-grades-loading');
    const container = document.getElementById('primary-grades-container');
    container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Chargement des cotes...</p></div>';
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'primary') {
            container.innerHTML = '<div class="no-data"><i class="fas fa-exclamation-circle"></i><p>Enfant non trouvé ou non du primaire</p></div>';
            hideLoading('primary-grades-loading');
            return;
        }
        
        const gradesQuery = query(
            collection(db, 'primary_published_grades'),
            where('studentId', '==', studentId),
            where('period', '==', period)
        );
        
        const gradesSnap = await getDocs(gradesQuery);
        
        if (gradesSnap.empty) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-chart-bar"></i>
                    <h3>Aucune cote publiée</h3>
                    <p>Aucune cote n'a été publiée pour la période ${period}</p>
                </div>
            `;
            hideLoading('primary-grades-loading');
            return;
        }
        
        let allGrades = [];
        let publishedDate = '';
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            publishedDate = gradeData.publishedAt ? 
                new Date(gradeData.publishedAt.toDate()).toLocaleDateString('fr-FR') : '';
            
            if (gradeData.grades && Array.isArray(gradeData.grades)) {
                gradeData.grades.forEach(courseGrade => {
                    allGrades.push({
                        courseName: courseGrade.courseName,
                        maxGrade: courseGrade.maxGrade || 0,
                        obtainedGrade: courseGrade.obtainedGrade || 0,
                        teacherName: courseGrade.teacherName || 'Non spécifié',
                        publishedDate: publishedDate
                    });
                });
            }
        });
        
        if (allGrades.length === 0) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-chart-bar"></i>
                    <h3>Aucune cote disponible</h3>
                    <p>Aucune cote trouvée pour la période ${period}</p>
                </div>
            `;
            hideLoading('primary-grades-loading');
            return;
        }
        
        const uniqueCourses = {};
        allGrades.forEach(grade => {
            if (!uniqueCourses[grade.courseName]) {
                uniqueCourses[grade.courseName] = grade;
            }
        });
        
        let html = `
            <div class="card">
                <h4>Cotes primaires - Période: ${period}</h4>
                ${publishedDate ? `<p style="color: #666; margin-bottom: 1rem;">Publié le: ${publishedDate}</p>` : ''}
                
                <div class="table-container">
                    <table class="primary-grades-table">
                        <thead>
                            <tr>
                                <th rowspan="2">N°</th>
                                <th rowspan="2">Cours</th>
                                <th rowspan="2">Enseignant</th>
                                <th colspan="2">Cotes</th>
                                <th rowspan="2">Date de publication</th>
                            </tr>
                            <tr>
                                <th class="course-header">CM</th>
                                <th class="course-header">CO</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        let index = 1;
        const courseNames = Object.keys(uniqueCourses);
        
        courseNames.forEach(courseName => {
            const grade = uniqueCourses[courseName];
            
            html += `
                <tr>
                    <td>${index}</td>
                    <td><strong>${courseName}</strong></td>
                    <td>${grade.teacherName}</td>
                    <td class="cm-cell">${grade.maxGrade}</td>
                    <td class="co-cell">${grade.obtainedGrade}</td>
                    <td>${grade.publishedDate}</td>
                </tr>
            `;
            index++;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
                    <h5>Légende :</h5>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 20px; height: 20px; background-color: #fff8e1; border: 1px solid #ffd54f;"></div>
                            <span>CM = Cote Maximale</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 20px; height: 20px; background-color: #e8f5e9; border: 1px solid #c8e6c9;"></div>
                            <span>CO = Cote Obtenue</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
        hideLoading('primary-grades-loading');
        
        markNotificationsAsRead('grades');
        
    } catch (error) {
        console.error('Erreur chargement cotes primaires:', error);
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>${error.message}</p>
            </div>
        `;
        hideLoading('primary-grades-loading');
    }
}

// ============================================
// FONCTIONS POUR LES COTES MATERNELLES
// ============================================
document.getElementById('kindergarten-grades-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const gradesContent = document.getElementById('kindergarten-grades-content');
    if (!studentId) {
        gradesContent.classList.add('hidden');
        return;
    }
    gradesContent.classList.remove('hidden');
    loadKindergartenGrades(studentId);
});

async function loadKindergartenGrades(studentId) {
    showLoading('kindergarten-grades-loading');
    const tableBody = document.getElementById('kindergarten-grades-table-body');
    
    try {
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child || child.type !== 'kindergarten') {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Enfant non trouvé ou non de la maternelle</td></tr>';
            hideLoading('kindergarten-grades-loading');
            return;
        }
        
        const gradesQuery = query(
            collection(db, 'kindergarten_grades'),
            where('studentId', '==', studentId),
            orderBy('evaluationDate', 'desc')
        );
        
        const gradesSnap = await getDocs(gradesQuery);
        
        if (gradesSnap.empty) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center;">
                        <div class="no-data">
                            <i class="fas fa-baby"></i>
                            <p>Aucune cote publiée pour cet enfant</p>
                        </div>
                    </td>
                </tr>
            `;
            hideLoading('kindergarten-grades-loading');
            return;
        }
        
        let html = '';
        let index = 1;
        
        const levels = {
            'excellent': 'Excellent',
            'tres_bien': 'Très bien',
            'bien': 'Bien',
            'suffisant': 'Suffisant',
            'insuffisant': 'Insuffisant'
        };
        
        gradesSnap.forEach(doc => {
            const gradeData = doc.data();
            const evaluationDate = gradeData.evaluationDate ? 
                new Date(gradeData.evaluationDate.toDate()).toLocaleDateString('fr-FR') : 'Non spécifiée';
            
            const levelText = levels[gradeData.level] || gradeData.level;
            const levelClass = gradeData.level === 'excellent' || gradeData.level === 'tres_bien' ? 'grade-green' : 
                             gradeData.level === 'insuffisant' ? 'grade-red' : '';
            
            html += `
                <tr>
                    <td>${index}</td>
                    <td>${gradeData.competence || 'Compétence'}</td>
                    <td class="${levelClass}">${levelText}</td>
                    <td>${gradeData.appreciation || 'Non spécifiée'}</td>
                    <td>${evaluationDate}</td>
                    <td>${gradeData.teacherName || 'Non spécifié'}</td>
                </tr>
            `;
            index++;
        });
        
        tableBody.innerHTML = html;
        hideLoading('kindergarten-grades-loading');
        
        markNotificationsAsRead('grades');
        
    } catch (error) {
        console.error('Erreur chargement cotes maternelle:', error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center;">
                    <div class="no-data">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erreur de chargement des cotes</p>
                    </div>
                </td>
            </tr>
        `;
        hideLoading('kindergarten-grades-loading');
    }
}

// ============================================
// FONCTIONS POUR L'HORAIRE
// ============================================
document.getElementById('timetable-child-selector').addEventListener('change', (e) => {
    const studentId = e.target.value;
    const timetableContent = document.getElementById('timetable-content');
    if (!studentId) {
        timetableContent.classList.add('hidden');
        return;
    }
    timetableContent.classList.remove('hidden');
});

document.getElementById('load-timetable-btn').addEventListener('click', loadTimetable);

async function loadTimetable() {
    showLoading('timetable-loading');
    const container = document.getElementById('timetable-display');
    
    const studentId = document.getElementById('timetable-child-selector').value;
    if (!studentId) {
        showAlert("Veuillez sélectionner un enfant", "error");
        hideLoading('timetable-loading');
        return;
    }
    
    try {
        const month = document.getElementById('timetable-month').value;
        const week = document.getElementById('timetable-week').value;
        
        const child = childrenList.find(c => c.matricule === studentId);
        if (!child) {
            container.innerHTML = '<p>Enfant non trouvé</p>';
            hideLoading('timetable-loading');
            return;
        }
        
        let timetableQuery;
        
        if (month && week) {
            timetableQuery = query(
                collection(db, 'student_schedules'),
                where('studentMatricule', '==', studentId),
                where('month', '==', month),
                where('week', '==', week),
                orderBy('publishedAt', 'desc')
            );
        } else if (month) {
            timetableQuery = query(
                collection(db, 'student_schedules'),
                where('studentMatricule', '==', studentId),
                where('month', '==', month),
                orderBy('publishedAt', 'desc')
            );
        } else {
            timetableQuery = query(
                collection(db, 'student_schedules'),
                where('studentMatricule', '==', studentId),
                orderBy('publishedAt', 'desc')
            );
        }
        
        const timetableSnap = await getDocs(timetableQuery);
        
        if (timetableSnap.empty) {
            container.innerHTML = `
                <div class="no-schedule">
                    <i class="fas fa-calendar-times"></i>
                    <h3>Aucun horaire disponible</h3>
                    <p>L'horaire de votre enfant n'a pas encore été publié pour la période sélectionnée.</p>
                </div>
            `;
            hideLoading('timetable-loading');
            return;
        }
        
        let html = '';
        
        timetableSnap.forEach(doc => {
            const timetableData = doc.data();
            const publishedDate = timetableData.publishedAt.toDate().toLocaleDateString('fr-FR');
            
            html += `
                <div class="timetable-section">
                    <div class="schedule-info">
                        <h4>Horaire de la classe ${timetableData.className} - Semaine ${timetableData.week} (${timetableData.month})</h4>
                        <p>Publié le ${publishedDate}</p>
                    </div>
                    <div class="table-container">
                        <table class="class-schedule-table">
                            <thead>
                                <tr>
                                    <th class="hour-header">Heures</th>
                                    <th class="day-header">Lundi</th>
                                    <th class="day-header">Mardi</th>
                                    <th class="day-header">Mercredi</th>
                                    <th class="day-header">Jeudi</th>
                                    <th class="day-header">Vendredi</th>
                                    <th class="day-header">Samedi</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            for (let hour = 1; hour <= 7; hour++) {
                html += `<tr><td class="hour-header">${hour}ère heure</td>`;
                
                const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                days.forEach(day => {
                    const course = timetableData.schedule.find(item => 
                        item.hour === hour && item.day === day
                    );
                    html += `<td>${course ? course.course : '-'}</td>`;
                });
                
                html += '</tr>';
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        hideLoading('timetable-loading');
        
    } catch (error) {
        console.error('Erreur chargement horaire:', error);
        container.innerHTML = `
            <div class="no-schedule">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger l'horaire. Veuillez réessayer plus tard.</p>
            </div>
        `;
        hideLoading('timetable-loading');
    }
}

// ============================================
// FONCTIONS POUR LE PROFIL
// ============================================
document.getElementById('profile-photo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (file.size > 5 * 1024 * 1024) {
            showAlert("La photo ne doit pas dépasser 5MB", "error");
            return;
        }
        if (!file.type.startsWith('image/')) {
            showAlert("Veuillez sélectionner une image valide", "error");
            return;
        }
        parentPhotoFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('profile-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
        }
        reader.readAsDataURL(file);
    }
});

document.getElementById('profile-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fullName = document.getElementById('profile-fullname').value;
    const email = document.getElementById('profile-email').value;
    const phone = document.getElementById('profile-phone').value;
    const newPassword = document.getElementById('profile-new-password').value;
    const confirmPassword = document.getElementById('profile-confirm-password').value;
    
    if (!fullName || !email || !phone) {
        showAlert("Veuillez remplir tous les champs obligatoires", "error");
        return;
    }
    
    if (newPassword && newPassword !== confirmPassword) {
        showAlert("Les mots de passe ne correspondent pas", "error");
        return;
    }
    
    try {
        let photoURL = currentParent.photoURL;
        
        if (parentPhotoFile) {
            photoURL = await uploadToCloudinary(parentPhotoFile, `parents/${currentParent.matricule}`);
        }
        
        const updateData = {
            fullName,
            email,
            phone,
            photoURL,
            updatedAt: serverTimestamp()
        };
        
        await updateDoc(doc(db, 'parents', currentParent.matricule), updateData);
        
        for (const child of childrenList) {
            let studentRef;
            if (child.type === 'secondary') {
                studentRef = doc(db, 'students', child.matricule);
            } else if (child.type === 'primary') {
                studentRef = doc(db, 'primary_students', child.matricule);
            } else {
                studentRef = doc(db, 'kindergarten_students', child.matricule);
            }
            
            await updateDoc(studentRef, {
                parentName: fullName,
                parentEmail: email,
                parentPhone: phone,
                updatedAt: serverTimestamp()
            });
        }
        
        if (newPassword) {
            showAlert("La modification du mot de passe nécessite une réinitialisation. Veuillez utiliser la fonction 'Mot de passe oublié'.", "info");
        }
        
        currentParent = { ...currentParent, ...updateData };
        document.getElementById('parent-name').textContent = fullName;
        
        if (photoURL) {
            document.getElementById('parent-photo-container').innerHTML = `<img src="${photoURL}" class="parent-photo" alt="Photo de profil">`;
        }
        
        showAlert("Profil mis à jour avec succès", "success");
        parentPhotoFile = null;
        
    } catch (error) {
        console.error("Erreur mise à jour profil:", error);
        showAlert("Erreur lors de la mise à jour du profil: " + error.message, "error");
    }
});

// ============================================
// FONCTIONS POUR AJOUTER UN ENFANT
// ============================================
document.getElementById('add-child-account-btn').addEventListener('click', () => {
    document.getElementById('add-child-modal').classList.remove('hidden');
});

document.getElementById('new-child-matricule').addEventListener('blur', async () => {
    const matricule = document.getElementById('new-child-matricule').value;
    const resultEl = document.getElementById('child-verification-result');
    
    if (!matricule) {
        resultEl.classList.add('hidden');
        return;
    }
    
    try {
        let studentData = null;
        let studentType = null;
        
        let studentDoc = await getDoc(doc(db, 'students', matricule));
        if (studentDoc.exists()) {
            studentData = studentDoc.data();
            studentType = 'secondary';
        } else {
            studentDoc = await getDoc(doc(db, 'primary_students', matricule));
            if (studentDoc.exists()) {
                studentData = studentDoc.data();
                studentType = 'primary';
            } else {
                studentDoc = await getDoc(doc(db, 'kindergarten_students', matricule));
                if (studentDoc.exists()) {
                    studentData = studentDoc.data();
                    studentType = 'kindergarten';
                }
            }
        }
        
        if (!studentData) {
            resultEl.innerHTML = '<p><i class="fas fa-times-circle"></i> Aucun élève trouvé avec ce matricule</p>';
            resultEl.className = 'alert alert-error';
            resultEl.classList.remove('hidden');
            return;
        }
        
        if (studentData.parentId) {
            resultEl.innerHTML = `<p><i class="fas fa-times-circle"></i> Cet élève est déjà associé à un compte parent</p>`;
            resultEl.className = 'alert alert-error';
            resultEl.classList.remove('hidden');
            return;
        }
        
        resultEl.innerHTML = `
            <p><i class="fas fa-check-circle"></i> Élève trouvé: <strong>${studentData.fullName}</strong> - <strong>${studentData.class}</strong> (${studentType === 'secondary' ? 'Secondaire' : studentType === 'primary' ? 'Primaire' : 'Maternelle'})</p>
        `;
        resultEl.className = 'alert alert-success';
        resultEl.classList.remove('hidden');
        
    } catch (error) {
        console.error("Erreur vérification matricule:", error);
        resultEl.innerHTML = '<p><i class="fas fa-times-circle"></i> Erreur lors de la vérification</p>';
        resultEl.className = 'alert alert-error';
        resultEl.classList.remove('hidden');
    }
});

document.getElementById('add-child-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const matricule = document.getElementById('new-child-matricule').value;
    const relation = document.getElementById('child-relation').value;
    
    if (!matricule) {
        showAlert("Veuillez entrer un matricule", "error");
        return;
    }
    
    try {
        let studentData = null;
        let studentType = null;
        
        let studentDoc = await getDoc(doc(db, 'students', matricule));
        if (studentDoc.exists()) {
            studentData = studentDoc.data();
            studentType = 'secondary';
        } else {
            studentDoc = await getDoc(doc(db, 'primary_students', matricule));
            if (studentDoc.exists()) {
                studentData = studentDoc.data();
                studentType = 'primary';
            } else {
                studentDoc = await getDoc(doc(db, 'kindergarten_students', matricule));
                if (studentDoc.exists()) {
                    studentData = studentDoc.data();
                    studentType = 'kindergarten';
                }
            }
        }
        
        if (!studentData) {
            showAlert("Aucun élève trouvé avec ce matricule", "error");
            return;
        }
        
        if (studentData.parentId) {
            showAlert("Cet élève est déjà associé à un compte parent", "error");
            return;
        }
        
        if (childrenList.find(child => child.matricule === matricule)) {
            showAlert("Cet élève est déjà dans votre liste", "error");
            return;
        }
        
        let studentRef;
        if (studentType === 'secondary') {
            studentRef = doc(db, 'students', matricule);
        } else if (studentType === 'primary') {
            studentRef = doc(db, 'primary_students', matricule);
        } else {
            studentRef = doc(db, 'kindergarten_students', matricule);
        }
        
        await updateDoc(studentRef, {
            parentId: currentParent.matricule,
            parentName: currentParent.fullName,
            parentEmail: currentParent.email,
            parentPhone: currentParent.phone,
            parentRelation: relation,
            updatedAt: serverTimestamp()
        });
        
        const updatedChildren = [...currentParent.children, {
            matricule: matricule,
            type: studentType
        }];
        await updateDoc(doc(db, 'parents', currentParent.matricule), {
            children: updatedChildren,
            updatedAt: serverTimestamp()
        });
        
        currentParent.children = updatedChildren;
        childrenList.push({
            matricule: matricule,
            type: studentType,
            ...studentData
        });
        
        const displayText = `${studentData.fullName} - ${studentData.class} (${studentType === 'secondary' ? 'Secondaire' : studentType === 'primary' ? 'Primaire' : 'Maternelle'})`;
        
        const generalSelectors = [
            document.getElementById('child-selector'), 
            document.getElementById('presence-child-selector'),
            document.getElementById('payment-child-selector'),
            document.getElementById('timetable-child-selector')
        ];
        generalSelectors.forEach(s => s.innerHTML += `<option value="${matricule}">${displayText}</option>`);
        
        if (studentType === 'secondary') {
            const secondarySelectors = [
                document.getElementById('secondary-grades-child-selector'),
                document.getElementById('secondary-homework-child-selector')
            ];
            secondarySelectors.forEach(s => s.innerHTML += `<option value="${matricule}">${studentData.fullName} - ${studentData.class}</option>`);
        } else if (studentType === 'primary') {
            const primarySelectors = [
                document.getElementById('primary-grades-child-selector'),
                document.getElementById('primary-homework-child-selector')
            ];
            primarySelectors.forEach(s => s.innerHTML += `<option value="${matricule}">${studentData.fullName} - ${studentData.class}</option>`);
        } else {
            const kindergartenSelectors = [
                document.getElementById('kindergarten-grades-child-selector'),
                document.getElementById('kindergarten-homework-child-selector')
            ];
            kindergartenSelectors.forEach(s => s.innerHTML += `<option value="${matricule}">${studentData.fullName} - ${studentData.class}</option>`);
        }
        
        updateChildrenPage();
        
        showAlert("Enfant ajouté avec succès", "success");
        document.getElementById('add-child-modal').classList.add('hidden');
        document.getElementById('add-child-form').reset();
        document.getElementById('child-verification-result').classList.add('hidden');
        
    } catch (error) {
        console.error("Erreur ajout enfant:", error);
        showAlert("Erreur lors de l'ajout de l'enfant: " + error.message, "error");
    }
});

// ============================================
// FONCTIONS POUR LES NOTIFICATIONS
// ============================================
function updateNotificationBadge(page, count) {
    const navItem = document.querySelector(`.nav-menu li a[data-page="${page}"]`);
    if (navItem) {
        const existingBadge = navItem.querySelector('.notification-badge');
        if (existingBadge) {
            existingBadge.remove();
        }
        
        if (count > 0) {
            const badge = document.createElement('span');
            badge.className = 'notification-badge';
            badge.textContent = count > 9 ? '9+' : count.toString();
            navItem.appendChild(badge);
        }
        
        notificationCounts[page] = count;
    }
}

function markNotificationsAsRead(page) {
    updateNotificationBadge(page, 0);
    
    const readNotifications = JSON.parse(localStorage.getItem('parent_read_notifications') || '{}');
    readNotifications[page] = new Date().toISOString();
    localStorage.setItem('parent_read_notifications', JSON.stringify(readNotifications));
}

function displayNotifications(filter = 'all') {
    const container = document.getElementById('notifications-list-container');
    
    let filteredNotifications = notifications;
    if (filter !== 'all') {
        filteredNotifications = notifications.filter(n => n.type === filter);
    }
    
    filteredNotifications = filteredNotifications.filter(notification => {
        if (!notification.childId) {
            return true;
        }
        return childrenList.some(child => child.matricule === notification.childId);
    });
    
    if (filteredNotifications.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-bell-slash"></i>
                <h3>Aucune notification</h3>
                <p>Vous n'avez aucune notification pour le moment.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    filteredNotifications.forEach(notification => {
        const date = new Date(notification.timestamp).toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const badgeClass = getBadgeClassForType(notification.type);
        const icon = getIconForType(notification.type);
        
        const childInfo = notification.childName ? 
            `<span style="color: var(--primary); margin-left: 5px;">(${notification.childName})</span>` : '';
        
        html += `
            <div class="notification-item ${notification.read ? 'read' : 'unread'}" data-id="${notification.id}">
                <div class="notification-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="${icon}" style="color: var(--${badgeClass});"></i>
                        <strong>${notification.title}</strong>
                        ${childInfo}
                        <span class="badge badge-${badgeClass}">${getTypeLabel(notification.type)}</span>
                    </div>
                    <div>
                        ${!notification.read ? '<span class="badge badge-danger" style="font-size: 0.7rem;">Nouveau</span>' : ''}
                        <small style="color: #666; margin-left: 10px;">${date}</small>
                    </div>
                </div>
                <div style="margin-left: 30px;">
                    <p>${notification.body}</p>
                    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                        ${!notification.read ? `
                            <button class="btn btn-success btn-sm" onclick="markNotificationAsRead('${notification.id}')">
                                <i class="fas fa-check"></i> Marquer comme lu
                            </button>
                        ` : ''}
                        <button class="btn btn-info btn-sm" onclick="viewNotification('${notification.id}')">
                            <i class="fas fa-eye"></i> Voir
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteNotification('${notification.id}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function getBadgeClassForType(type) {
    const typeMap = {
        'grades': 'success',
        'homework': 'warning',
        'incidents': 'danger',
        'payments': 'info',
        'messages': 'primary',
        'communiques': 'secondary',
        'test': 'info'
    };
    return typeMap[type] || 'primary';
}

function getIconForType(type) {
    const iconMap = {
        'grades': 'fas fa-chart-line',
        'homework': 'fas fa-book',
        'incidents': 'fas fa-exclamation-triangle',
        'payments': 'fas fa-money-bill',
        'messages': 'fas fa-envelope',
        'communiques': 'fas fa-newspaper',
        'test': 'fas fa-bell'
    };
    return iconMap[type] || 'fas fa-bell';
}

function getTypeLabel(type) {
    const labelMap = {
        'grades': 'Nouvelle note',
        'homework': 'Devoir',
        'incidents': 'Incident',
        'payments': 'Paiement',
        'messages': 'Message',
        'communiques': 'Communiqué',
        'test': 'Test'
    };
    return labelMap[type] || 'Notification';
}

// ============================================
// NAVIGATION
// ============================================
document.querySelectorAll('.nav-menu a').forEach(link => {
    link.addEventListener('click', e => {
        e.preventDefault();
        const page = link.dataset.page;
        
        markNotificationsAsRead(page);
        
        const pageId = page + '-page';
        document.querySelectorAll('.nav-menu a, .page').forEach(el => el.classList.remove('active'));
        link.classList.add('active');
        document.getElementById(pageId).classList.add('active');
        document.getElementById('page-title').textContent = link.textContent;
        
        if (window.innerWidth <= 768) {
            document.querySelector('.sidebar').classList.add('collapsed');
        }
        
        if (page === 'dashboard') {
            document.getElementById('child-selector').value = '';
            document.getElementById('child-dashboard-content').classList.add('hidden');
        } else if (page === 'presence-incidents') {
            document.getElementById('presence-child-selector').value = '';
            document.getElementById('presence-incidents-content').classList.add('hidden');
        } else if (page === 'payments') {
            document.getElementById('payment-child-selector').value = '';
            document.getElementById('payment-content').classList.add('hidden');
        } else if (page === 'timetable') {
            document.getElementById('timetable-child-selector').value = '';
            document.getElementById('timetable-content').classList.add('hidden');
        } else if (page === 'notifications') {
            displayNotifications(document.getElementById('notification-filter').value);
        }
    });
});

// ============================================
// GESTION DU MENU MOBILE
// ============================================
document.getElementById('menu-toggle').addEventListener('click', function() {
    const sidebar = document.querySelector('.sidebar');
    sidebar.classList.toggle('collapsed');
});

document.addEventListener('click', (e) => {
    const sidebar = document.querySelector('.sidebar');
    const menuToggle = document.getElementById('menu-toggle');
    
    if (!sidebar.contains(e.target) && !menuToggle.contains(e.target) && window.innerWidth <= 768) {
        sidebar.classList.add('collapsed');
    }
});

// ============================================
// SOUS-ONGLETS
// ============================================
function setupSubTabs() {
    document.querySelectorAll('#grades-page .sub-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const subTabId = tab.getAttribute('data-sub-tab');
            
            document.querySelectorAll('#grades-page .sub-tab, #grades-page .sub-tab-content').forEach(el => el.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(`${subTabId}-tab`).classList.add('active');
            
            document.getElementById('secondary-grades-child-selector').value = '';
            document.getElementById('secondary-grades-content').classList.add('hidden');
            document.getElementById('primary-grades-child-selector').value = '';
            document.getElementById('primary-grades-content').classList.add('hidden');
            document.getElementById('kindergarten-grades-child-selector').value = '';
            document.getElementById('kindergarten-grades-content').classList.add('hidden');
        });
    });
    
    document.querySelectorAll('#homework-page .sub-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const subTabId = tab.getAttribute('data-sub-tab');
            
            document.querySelectorAll('#homework-page .sub-tab, #homework-page .sub-tab-content').forEach(el => el.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(`${subTabId}-tab`).classList.add('active');
            
            document.getElementById('secondary-homework-child-selector').value = '';
            document.getElementById('secondary-homework-content').classList.add('hidden');
            document.getElementById('primary-homework-child-selector').value = '';
            document.getElementById('primary-homework-content').classList.add('hidden');
            document.getElementById('kindergarten-homework-child-selector').value = '';
            document.getElementById('kindergarten-homework-content').classList.add('hidden');
        });
    });
}

// ============================================
// GESTION DES MODALS
// ============================================
document.querySelectorAll('.close-modal').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hidden'));
    });
});

document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.add('hidden');
        }
    });
});

window.closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden');

// ============================================
// BOUTON NOTIFICATION
// ============================================
document.getElementById('notification-bell').addEventListener('click', () => {
    const link = document.querySelector('.nav-menu a[data-page="notifications"]');
    if (link) link.click();
});

document.getElementById('notification-filter').addEventListener('change', (e) => {
    displayNotifications(e.target.value);
});

document.getElementById('clear-all-notifications-btn').addEventListener('click', clearAllNotifications);

// ============================================
// BOUTONS DE NOTIFICATION DANS LE PROFIL
// ============================================
document.getElementById('enable-notifications-btn').addEventListener('click', async () => {
    const granted = await requestNotificationPermission();
    if (granted) {
        await updateDoc(doc(db, 'parents', currentParent.matricule), {
            notificationEnabled: true,
            notificationEnabledAt: serverTimestamp()
        });
        
        currentParent.notificationEnabled = true;
        updateProfileForm();
    }
});

document.getElementById('test-notification-btn').addEventListener('click', testNotification);

// ============================================
// INITIALISATION
// ============================================
setupSubTabs();
</script>
<button onclick="testNotification()" class="btn btn-warning btn-sm">
  <i class="fas fa-bell"></i> Tester notification
</button>

<script>
window.testNotification = function() {
  sendNotification({
    title: '🔔 Test réussi',
    body: 'Les notifications fonctionnent parfaitement !',
    type: 'test',
    page: 'dashboard',
    timestamp: new Date().toISOString()
  });
};
</script>
